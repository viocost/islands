!function(e){function t(t){for(var i,a,o=t[0],c=t[1],l=t[2],d=0,p=[];d<o.length;d++)a=o[d],Object.prototype.hasOwnProperty.call(r,a)&&r[a]&&p.push(r[a][0]),r[a]=0;for(i in c)Object.prototype.hasOwnProperty.call(c,i)&&(e[i]=c[i]);for(u&&u(t);p.length;)p.shift()();return s.push.apply(s,l||[]),n()}function n(){for(var e,t=0;t<s.length;t++){for(var n=s[t],i=!0,o=1;o<n.length;o++){var c=n[o];0!==r[c]&&(i=!1)}i&&(s.splice(t--,1),e=a(a.s=n[0]))}return e}var i={},r={0:0},s=[];function a(t){if(i[t])return i[t].exports;var n=i[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,a),n.l=!0,n.exports}a.m=e,a.c=i,a.d=function(e,t,n){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(a.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)a.d(n,i,function(t){return e[t]}.bind(null,i));return n},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="";var o=window.webpackJsonp=window.webpackJsonp||[],c=o.push.bind(o);o.push=t,o=o.slice();for(var l=0;l<o.length;l++)t(o[l]);var u=c;s.push([374,1]),n()}({159:function(e,t){},265:function(e,t){},267:function(e,t){},300:function(e,t){},301:function(e,t){},343:function(e,t,n){var i=n(344);"string"==typeof i&&(i=[[e.i,i,""]]);var r={hmr:!0,transform:void 0,insertInto:void 0};n(345)(i,r);i.locals&&(e.exports=i.locals)},344:function(e,t,n){},371:function(e,t){},374:function(e,t,n){"use strict";n.r(t);n(91),n(224),n(95),n(234),n(47),n(238),n(76),n(56),n(57),n(31),n(39);var r=n(0),s=n.n(r),a=(n(152),n(8)),o=n.n(a),c=(n(245),n(247),n(248),n(77),n(11)),l=n.n(c),u=n(13),d=n.n(u),p=n(128),h=n.n(p),y=n(1),v=n(262),g=function(){function e(){l()(this,e);var t=this;t.settings={},t.locked=!1,t.setEncodersAndDecoders(),t.symCiphers=["aes"],t.streamCiphers=["chacha"],t.asymCiphers=["rsa"],t.store={},t.rsa={createKeyPair:function(){return t.generateRSAKeyPair.apply(t,arguments)},asyncCreateKeyPair:function(){return t.asyncGenerateRSAKeyPair.apply(t,arguments)},encrypt:function(){return t.publicKeyEncrypt.apply(t,arguments)},decrypt:function(){return t.privateKeyDecrypt.apply(t,arguments)},sign:function(){return t.privateKeySign.apply(t,arguments)},verify:function(){return t.publicKeyVerify.apply(t,arguments)},setKey:function(){return t.setRSAKey.apply(t,arguments)},getSettings:function(){return"RSA"}},t.aes={modes:["CBC","CFB","CTR"],mode:"CBC",ivLength:16,keySize:32,createKey:function(){return t.createSYMKey.apply(t,arguments)},encrypt:function(){return t.AESEncrypt.apply(t,arguments)},decrypt:function(){return t.AESDecrypt.apply(t,arguments)},setKey:function(){return t.setSYMKey.apply(t,arguments)},getSettings:function(){return"AES"}},t.chacha={init:function(){return t.initStreamCryptor.apply(t,arguments)},encrypt:function(){return t.streamCryptorEncrypt.apply(t,arguments)},decrypt:function(){return t.streamCryptorDecrypt.apply(t,arguments)},getSettings:function(){return"ChaCha"}},t.setAsymCipher("rsa"),t.setSymCipher("aes"),t.setStreamCipher("chacha")}return d()(e,[{key:"setSymCipher",value:function(){for(var e=this,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];if(!e.symCiphers.includes(n[0]))throw"setSymCipher: Invalid or unsupported algorithm";e.sym=e[n[0]]}},{key:"setAsymCipher",value:function(){for(var e=this,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];if(!e.asymCiphers.includes(n[0]))throw"setSymCipher: Invalid or unsupported algorithm";e.asym=e[n[0]]}},{key:"setStreamCipher",value:function(){for(var e=this,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];if(!e.streamCiphers.includes(n[0]))throw"setSymCipher: Invalid or unsupported algorithm";e.ssym=e[n[0]]}},{key:"setEncodersAndDecoders",value:function(){this.encoders={hex:e.hexEncode,base64:e.base64Encode},this.decoders={hex:e.hexDecode,base64:e.base64Decode}}},{key:"asyncCreateNonce",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:32;return new Promise((function(i,r){try{i(t.createNonce(e,n))}catch(e){r(e)}}))}},{key:"createNonce",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("createNonce"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:32;return this.set(t,e.getBytes(n)),this}},{key:"asyncAddBlob",value:function(e,t){var n=this;return new Promise((function(i,r){try{i(n.addBlob(e,t))}catch(e){r(e)}}))}},{key:"addBlob",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("addBlob"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("addBlob");return this.set(t,n.toString().trim()),this}},{key:"asyncCreateSYMKey",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:16,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:32;return new Promise((function(r,s){try{r(t.createSYMKey(e,n,i))}catch(e){s(e)}}))}},{key:"createSYMKey",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("createSYMKey"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:32,i=this,r=e.getBytes(n);return i.set(t,y.util.bytesToHex(r)),i}},{key:"setSYMKey",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("setSYMKey"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("setSYMKey");return this.set(t,n),this}},{key:"createPasswordBasedSymKey",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("createSYMKey"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("createSYMKey"),i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.pRequired("createSYMKey"),r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2e4,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:32,a=this,o=y.util.hexToBytes(this.get(i)),c=y.pkcs5.pbkdf2(n,o,r,s),l=y.util.bytesToHex(c);return a.set(t,l),a}},{key:"asyncAESEncrypt",value:function(e,t,n,i,r,s){var a=this;return new Promise((function(o,c){try{o(a.AESEncrypt(e,t,n,i,r,s))}catch(e){c(e)}}))}},{key:"AESEncrypt",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("AESEncrypt"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("AESEncrypt"),i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.pRequired("AESEncrypt"),r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"CBC",a=arguments.length>5?arguments[5]:void 0,o=this;if(!o.aes.modes.includes(s.toUpperCase()))throw"AESencrypt: Invalid AES mode";s="AES-"+s.toUpperCase();var c=e.getBytes(16),l=y.util.hexToBytes(o.get(n)),u=y.cipher.createCipher(s,l);return u.start({iv:c}),u.update(y.util.createBuffer(this.get(t),a)),u.finish(),this.set(i,r?y.util.bytesToHex(c)+u.output.toHex():c+u.output),this}},{key:"asyncAESDecrypt",value:function(e,t,n){var i=this;return new Promise((function(r,s){try{r(i.AESDecrypt(e,t,n))}catch(e){s(e)}}))}},{key:"AESDecrypt",value:function(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("AESDecrypt"),i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("AESDecrypt"),r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.pRequired("AESDecrypt"),s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"CBC",o=(arguments.length>5&&arguments[5],this);if(!o.aes.modes.includes(a.toUpperCase()))throw"AESencrypt: Invalid AES mode";a="AES-"+a.toUpperCase();var c,l=o.get(n);s?(c=y.util.hexToBytes(l.substring(0,32)),t=y.util.hexToBytes(l.substr(32))):(t=l.substr(16),c=l.substring(0,16));var u=y.util.hexToBytes(this.get(i)),d=y.cipher.createDecipher(a,u);return d.start({iv:c}),d.update(y.util.createBuffer(t)),d.finish(),this.set(r,d.output.toString("utf8")),this}},{key:"asyncHash",value:function(e,t){var n=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"sha256";return new Promise((function(r,s){try{r(n.hash(e,t,i))}catch(e){s(e)}}))}},{key:"hashFileWorker",value:function(){var t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("fileHashWorker file"),i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("fileHashWorker nameToSave");arguments.length>2&&void 0!==arguments[2]&&arguments[2];return new Promise((function(e,r){var s=t;if(void 0===Worker)throw"Web workers are not supported in current environment";var a=new Worker("/js/iCryptoWorker.js");a.onmessage=function(t){"success"===t.data[0]?(s.set(i,t.data[1]),e(s),a.terminate()):(r(t.data[1]),a.terminate())},a.postMessage(["hashFile",n])}))}},{key:"initStreamCryptor",value:function(){var t,n,i,r,s,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("initStreamEncryptor"),o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("initStreamEncryptor"),c=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],l=(arguments.length>3&&void 0!==arguments[3]&&arguments[3],this),u="enc";if((i=e.hexDecode(o)).length<16)throw"chacha20: invalid key size: "+i.length+" key length must be 32 bytes";var d=e.stringToArrayBuffer(i).slice(0,32);c?(t=e.getBytes(6),n=e.hexEncode(t),s=e.stringToArrayBuffer(t).slice(0,12),r=new h.a(new Uint8Array(d),new Uint8Array(s),0)):(u="dec",s=new ArrayBuffer(0));var p=new function(){var t=this;t.cryptor=r,t.key=o,t.iv=n,t.mode=u,t.encryptionMode=function(){return"enc"===t.mode},t.decryptionMode=function(){return"dec"===t.mode},t.encrypt=function(n){var i="string"==typeof n?e.stringToArrayBuffer(n):n;if(!(i instanceof ArrayBuffer||i instanceof Uint8Array))throw"StreamCryptor encrypt: input type is invalid";if(0===t.cryptor._byteCounter){var r=t.cryptor.encrypt(new Uint8Array(i));return e.concatUint8Arrays(new Uint8Array(s),r)}return t.cryptor.encrypt(new Uint8Array(i))},t.decrypt=function(n){var i="string"==typeof n?e.stringToArrayBuffer(n):n;if(!(i instanceof ArrayBuffer))throw"StreamCryptor encrypt: input type is invalid";if(void 0===t.cryptor){if(s.byteLength+i.byteLength<=12)return s=e.concatArrayBuffers(s,i),new Uint8Array;var r=12-s.byteLength;s=e.concatArrayBuffers(s,i.slice(0,r)),t.iv=e.hexEncode(e.arrayBufferToString(s)),t.cryptor=new h.a(new Uint8Array(d),new Uint8Array(s),0);var a=new Uint8Array(i.slice(r,i.byteLength));return t.cryptor.decrypt(a)}return t.cryptor.decrypt(new Uint8Array(i))}};return l.set(a,p),l}},{key:"streamCryptorGetIV",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("streamCryptorGetIV"),n=this,i=n.get(t);return i.iv}},{key:"streamCryptorEncrypt",value:function(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("streamCryptorEncrypt"),i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("streamCryptorEncrypt"),r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"raw",s=this,a=s.get(n);if(!a.encryptionMode())throw"streamCryptorEncrypt error: mode is invalid";if(i instanceof ArrayBuffer)t=i;else if(i instanceof Uint8Array)t=i.buffer;else{if("string"!=typeof i)throw"streamCryptorEncrypt: invalid format input";t=e.stringToArrayBuffer(i)}if(void 0===r||"raw"===r)return a.encrypt(t).buffer;throw"NOT IMPLEMENTED"}},{key:"streamCryptorDecrypt",value:function(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("streamCryptorEncrypt"),i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("streamCryptorEncrypt"),r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"raw",s=this,a=s.get(n);if(!a.decryptionMode())throw"streamCryptorEncrypt error: mode is invalid";if(i instanceof ArrayBuffer)t=i;else if(i instanceof Uint8Array)t=i.buffer;else{if("string"!=typeof i)throw"streamCryptorEncrypt: invalid format input";t=e.stringToArrayBuffer(i)}if(void 0===r||"raw"===r)return a.decrypt(t).buffer;throw"NOT IMPLEMENTED"}},{key:"hash",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("hash"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("hash"),i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"sha256",r=this,s=r.get(t);if("string"!=typeof s)throw"hash: invalid target type: "+typeof s+"  Target must be string.";i=i.toLowerCase();var a=y.md.hasOwnProperty(i)?y.md[i].create():this.throwError("Wrong hash algorithm");return a.update(s),this.set(n,a.digest().toHex()),r}},{key:"createHash",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("createHash"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"sha256";console.log("Create hash called."),console.log("sjcl is ".concat(typeof v));for(var i=0,r=Object.keys(v);i<r.length;i++){var s=r[i];console.log(s)}var a=v.hash.hasOwnProperty(n)?new v.hash[n]:this.throwError("Wrong hash algorithm");return this.set(t,a),this}},{key:"updateHash",value:function(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("updateHash: target"),i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("updateHash: blob"),r=this;if("string"==typeof i)t=e.stringToArrayBuffer(i);else if(i instanceof Uint8Array)t=i.buffer;else{if(!(i instanceof ArrayBuffer))throw"invalid input format!";t=i}var s=r.get(n);return s.update(v.codec.arrayBuffer.toBits(t)),r}},{key:"digestHash",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("digestHash"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("digestHash"),i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=this,s=r.get(t),a=i?v.codec.hex.fromBits(s.finalize()):v.codec.arrayBuffer.fromBits(s.finalize());return this.set(n,a),r}},{key:"asyncGenerateRSAKeyPair",value:function(){var t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("asyncGenerateRSAKeyPair"),i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2048;return new Promise((function(e,r){var s=t;y.rsa.generateKeyPair({bits:i,workers:-1},(function(i,a){if(i)r(i);else try{var o=y.pki.publicKeyToPem(a.publicKey),c=y.pki.privateKeyToPem(a.privateKey);s.set(n,{publicKey:o,privateKey:c}),e(t)}catch(i){r(i)}}))}))}},{key:"generateRSAKeyPair",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("generateRSAKeyPair"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2048,i=this,r=y.pki.rsa.generateKeyPair({bits:n,e:65537}),s=y.pki.publicKeyToPem(r.publicKey),a=y.pki.privateKeyToPem(r.privateKey);return i.set(t,{publicKey:s,privateKey:a}),i}},{key:"publicFromPrivate",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("publicFromPrivate"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("publicFromPrivate"),i=y.pki.privateKeyFromPem(this.get(t));return this.set(n,y.pki.publicKeyToPem(i)),this}},{key:"setRSAKey",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("setRSAPublicKey"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("setRSAPublicKey"),i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.pRequired("setRSAPublicKey");if("public"!==i&&"private"!==i)throw"Invalid key type";return e.isRSAPEMValid(n,i)||(n=e.base64ToPEM(n,i)),"public"===i?y.pki.publicKeyFromPem(n):y.pki.privateKeyFromPem(n),this.set(t,n),this}},{key:"asyncPublicKeyEncrypt",value:function(e,t,n,i){var r=this;return new Promise((function(i,s){try{i(r.publicKeyEncrypt(e,t,n))}catch(e){s(e)}}))}},{key:"getPublicKeyFingerprint",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("getPublicKeyFingerpint"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("getPublicKeyFingerpint"),i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"sha256",r=this.validateExtractRSAKey(this.get(t),"public"),s=y.pki.publicKeyFromPem(r),a=y.pki.getPublicKeyFingerprint(s,{encoding:"hex",md:y.md[i].create()});return this.set(n,a),this}},{key:"publicKeyEncrypt",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("publicKeyEncrypt"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("publicKeyEncrypt"),i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.pRequired("publicKeyEncrypt"),r=arguments.length>3?arguments[3]:void 0;n=this.validateExtractRSAKey(this.get(n),"public");var s=y.pki.publicKeyFromPem(n),a=s.encrypt(this.get(t));return r&&(a=this._encodeBlob(a,r)),this.set(i,a),this}},{key:"_encodeBlob",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("_encodeBlob"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("_encodeBlob"),i=this;if(!this.encoders.hasOwnProperty(n))throw"_encodeBlob: Invalid encoding: "+n;return i.encoders[n](t)}},{key:"_decodeBlob",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("_encodeBlob"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("_encodeBlob");if(!this.encoders.hasOwnProperty(n))throw"_decodeBlob: Invalid encoding: "+n;return this.decoders[n](t)}},{key:"asyncPrivateKeyDecrypt",value:function(e,t,n){var i=this;return new Promise((function(r,s){try{r(i.privateKeyDecrypt(e,t,n))}catch(e){s(e)}}))}},{key:"privateKeyDecrypt",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("privateKeyDecrypt"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("privateKeyDecrypt"),i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.pRequired("privateKeyDecrypt"),r=arguments.length>3?arguments[3]:void 0;n=this.validateExtractRSAKey(this.get(n),"private");var s=y.pki.privateKeyFromPem(n),a=this.get(t);return r&&(a=this._decodeBlob(a,r)),this.set(i,s.decrypt(a)),this}},{key:"asyncPrivateKeySign",value:function(e,t,n){var i=this;return new Promise((function(r,s){try{r(i.privateKeySign(e,t,n))}catch(e){s(e)}}))}},{key:"privateKeySign",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("privateKeyEncrypt"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("privateKeyEncrypt"),i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.pRequired("privateKeyEncrypt"),r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"sha256",s=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];n=this.validateExtractRSAKey(this.get(n),"private");var a=y.pki.privateKeyFromPem(n),o=y.md[r].create();o.update(this.get(t));var c=a.sign(o);return c=s?y.util.bytesToHex(c):c,this.set(i,c),this}},{key:"asyncPublicKeyVerify",value:function(e,t,n,i){var r=this;return new Promise((function(s,a){try{s(r.publicKeyVerify(e,t,n,i))}catch(e){a(e)}}))}},{key:"publicKeyVerify",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("publicKeyVerify"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("publicKeyVerify"),i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.pRequired("publicKeyVerify"),r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.pRequired("publicKeyVerify"),s=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];i=this.validateExtractRSAKey(this.get(i),"public");var a=y.pki.publicKeyFromPem(i),o=y.md.sha256.create();o.update(this.get(t));var c=this.get(n);c=s?y.util.hexToBytes(c):c;var l=a.verify(o.digest().bytes(),c);return this.set(r,l),this}},{key:"validateExtractRSAKey",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("validateAndExtractRSAKey"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("validateAndExtractRSAKey"),i={public:"publicKey",private:"privateKey"};if(!Object.keys(i).includes(n))throw"validateExtractRSAKey: key type is invalid!";if(t[i[n]]&&(t=t[i[n]]),!e.isRSAPEMValid(t,n))throw console.log(n),console.log(t),"validateExtractRSAKey: Invalid key format";return t}},{key:"pemToBase64",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("pemToBase64"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("pemToBase64"),i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.pRequired("pemToBase64"),r=this.get(t);if(!e.isRSAPEMValid(r,i))throw console.log(i),console.log(r),"validateExtractRSAKey: Invalid key format";r=r.trim().split(/\r?\n/).slice(1,-1).join(""),this.set(n,r)}},{key:"asyncCompress",value:function(e,t){}},{key:"compress",value:function(){arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("compress"),arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("compress")}},{key:"asyncDecompress",value:function(e,t){}},{key:"decompress",value:function(){arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("decompress"),arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("decompress")}},{key:"encode",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("encode"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("encode"),i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.pRequired("encode"),r=this;return r.set(i,r._encodeBlob(this.get(t),n)),this}},{key:"base64Encode",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("base64Encode"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("base64Encode"),i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=i?JSON.stringify(this.get(t)):this.get(t);return this.set(n,e.base64Encode(r)),this}},{key:"base64Decode",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("base64decode"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("base64decode"),i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=e.base64Decode(this.get(t));return r=i?JSON.parse(r):r,this.set(n,r),this}},{key:"bytesToHex",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("bytesToHex"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("bytesToHex"),i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=i?JSON.stringify(this.get(t)):this.get(t);return this.set(n,e.hexEncode(r)),this}},{key:"hexToBytes",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("hexToBytes"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("hexToBytes"),i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=e.hexDecode(this.get(t));return r=i?JSON.parse(r):r,this.set(n,r),this}},{key:"stringifyJSON",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("stringify"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("stringify"),i=this.get(t);if("object"!=typeof i)throw"stringifyJSON: target invalid";return this.set(n,JSON.stringify(i)),this}},{key:"parseJSON",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("stringify"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("stringify"),i=this.get(t);if("string"!=typeof i)throw"stringifyJSON: target invalid";return this.set(n,JSON.parse(i)),this}},{key:"merge",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("merge"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("merge");if(!this.keysExist(t))throw"merge: some or all objects with such keys not found ";for(var i="",r=0;r<t.length;++r){var s=this.get(t[r]);if("string"!=typeof s&&"number"!=typeof s)throw"Object "+t[r]+" is not mergeable";i+=s}return this.set(n,i),this}},{key:"encodeBlobLength",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.pRequired("encodeBlobLength"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.pRequired("encodeBlobLength"),i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.pRequired("encodeBlobLength"),r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.pRequired("encodeBlobLength");if("string"!=typeof i)throw"encodeBlobLength: Invalid padding char";var s=String(this.get(t).length),a=n-s.length;if(a<0)throw"encodeBlobLength: String length exceedes target length";var o=i[0].repeat(a);return this.set(r,o+s),this}},{key:"get",value:function(e){if(this.keysExist(e))return this.store[e];throw"Property "+e+" not found"}},{key:"set",value:function(e,t){if(this.locked)throw"Cannot add property: object locked";this.assertKeysAvailable(e),this.store[e]=t}},{key:"lock",value:function(){this.locked=!0}},{key:"unlock",value:function(){this.locked=!1}},{key:"assertKeysAvailable",value:function(e){if(this.keysExist(e))throw"Cannot add property: "+e.toString()+" property with such name already exists"}},{key:"keysExist",value:function(e){if(!e)throw"keysExist: Missing required arguments";if("string"==typeof e||"number"==typeof e)return this._keyExists(e);if("object"!=typeof e)throw"keysExist: unsupported type";if(e.length<1)throw"array must have at least one key";for(var t=Object.keys(this.store),n=0;n<e.length;++n)if(!t.includes(e[n].toString()))return!1;return!0}},{key:"_keyExists",value:function(e){if(!e)throw"keyExists: Missing required arguments";return Object.keys(this.store).includes(e.toString())}},{key:"throwError",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Unknown error";throw e}}],[{key:"isRSAPEMValid",value:function(e,t){var n="public"===t?/^-{4,5}BEGIN.*PUBLIC.*KEY.*-{4,5}/:/^-{4,5}BEGIN.*PRIVATE.*KEY.*-{4,5}/,i="public"===t?/^-{4,5}END.*PUBLIC.*KEY.*-{4,5}/:/^-{4,5}END.*PRIVATE.*KEY.*-{4,5}/,r=!0,s=(e=(e=e.trim()).replace(/\r?\n$/,"")).split(/\r?\n/);return r=r&&s.length>2&&n.test(s[0])&&i.test(s[s.length-1])}},{key:"base64ToPEM",value:function(e,t){for(var n="public"===t?"-----END PUBLIC KEY-----":"-----END RSA PRIVATE KEY-----",i="public"===t?"-----BEGIN PUBLIC KEY-----":"-----BEGIN RSA PRIVATE KEY-----",r=0;r<e.length;++r)i+=r%64==0?"\r\n"+e[r]:e[r];return i+="\r\n"+n}},{key:"arrayBufferToString",value:function(e){return String.fromCharCode.apply(null,new Uint16Array(e))}},{key:"stringToArrayBuffer",value:function(e){for(var t=new ArrayBuffer(2*e.length),n=new Uint16Array(t),i=0,r=e.length;i<r;i++)n[i]=e.charCodeAt(i);return t}},{key:"concatUint8Arrays",value:function(e,t){var n=new Uint8Array(e.byteLength+t.byteLength);return n.set(e,0),n.set(t,e.byteLength),n}},{key:"concatArrayBuffers",value:function(e,t){var n=new Uint8Array(e.byteLength+t.byteLength);return n.set(new Uint8Array(e),0),n.set(new Uint8Array(t),e.byteLength),n.buffer}},{key:"getBytes",value:function(e){return y.random.getBytesSync(e)}},{key:"hexEncode",value:function(e){return y.util.bytesToHex(e)}},{key:"hexDecode",value:function(e){return y.util.hexToBytes(e)}},{key:"base64Encode",value:function(e){return y.util.encode64(e)}},{key:"base64Decode",value:function(e){return y.util.decode64(e)}},{key:"randInt",value:function(e,t){if(void 0===t&&(t=e,e=0),"number"!=typeof e||"number"!=typeof t)throw new TypeError("Expected all arguments to be numbers");return Math.floor(Math.random()*(t-e+1)+e)}},{key:"createRandomHexString",value:function(t){var n=e.getBytes(t),i=e.hexEncode(n),r=e.randInt(0,i.length-t);return i.substring(r,r+t)}},{key:"pRequired",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"iCrypto function";throw e+": missing required parameter!"}}]),e}();function f(e,t){var n=Number(t)||8;function i(){e.style.width=(e.value.length+1)*n+"px"}var r="keyup,keypress,focus,blur,change".split(","),s=!0,a=!1,o=void 0;try{for(var c,l=r[Symbol.iterator]();!(s=(c=l.next()).done);s=!0){var u=c.value;e.addEventListener(u,i,!1)}}catch(e){a=!0,o=e}finally{try{s||null==l.return||l.return()}finally{if(a)throw o}}i()}n(343);function m(e,t){var n=document.createElement(e);if(!t)return n;if(t.classes)if("object"==typeof t.classes){var i=!0,r=!1,s=void 0;try{for(var a,o=t.classes[Symbol.iterator]();!(i=(a=o.next()).done);i=!0){var c=a.value;n.classList.add(c)}}catch(e){r=!0,s=e}finally{try{i||null==o.return||o.return()}finally{if(r)throw s}}}else{if("string"!=typeof t.classes)throw"Bake parameters invalid";n.classList.add(t.classes)}if(t.listeners)for(var l=0,u=Object.keys(t.listeners);l<u.length;l++){var d=u[l];n.addEventListener(d,t.listeners[d])}if(t.id&&n.setAttribute("id",t.id),t.attributes)for(var p=0,h=Object.keys(t.attributes);p<h.length;p++){var y=h[p];n.setAttribute(y,t.attributes[y])}return t.html&&(n.innerHTML=t.html),t.text&&(n.innerText=t.text),t.val&&(n.value=t.val),n}function b(e,t){if(t instanceof Array){var n=!0,i=!1,r=void 0;try{for(var s,a=t[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var o=s.value;e.appendChild(o)}}catch(e){i=!0,r=e}finally{try{n||null==a.return||a.return()}finally{if(i)throw r}}}else e.appendChild(t)}function k(e){return document.querySelector(e)}function w(e){k(e).style.display="none"}function S(e){k(e).style.display="flex"}var E=n(6),K=function(){function e(t,n,i,r,s,a,o,c){var u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:"sha256";l()(this,e);this.name=t.name,this.size=t.size,this.type=t.type,this.lastModified=t.lastModified,this.pkfp=i,this.metaID=r,this.hashAlgorithm=u,this.messageID=a,this.hashEncrypted=o,this.hashUnencrypted=c,this.link=this.buildLink(n,i,this.hashUnencrypted),this.signHashes(s)}return d()(e,[{key:"get",value:function(){return{name:this.name,size:this.size,type:this.type,lastModified:this.lastModified,pkfp:this.pkfp,hashEncrypted:this.hashEncrypted,hashUnencrypted:this.hashUnencrypted,signEncrypted:this.signEncrypted,signUnencrypted:this.signUnencrypted,metaID:this.metaID,messageID:this.messageID,link:this.link,hashAlgorithm:this.hashAlgorithm}}},{key:"getLink",value:function(){return this.link}},{key:"buildLink",value:function(e,t,n){if(!e||!t||!n)throw"Attachment buildLink: missing required parameters";var i=e+"/"+t+"/"+n,r=new g;return r.addBlob("l",i).base64Encode("l","l64"),r.get("l64")}},{key:"signHashes",value:function(e){if(!e)throw"Attachment signAttachmentHash: privKey is undefined";var t=new g;t.addBlob("hu",this.hashUnencrypted).addBlob("he",this.hashEncrypted).asym.setKey("pk",e,"private").asym.sign("hu","pk","sign_u").asym.sign("he","pk","sign_e"),this.signUnencrypted=t.get("sign_u"),this.signEncrypted=t.get("sign_e")}}],[{key:"verifyFileInfo",value:function(e){for(var t=0,n=["name","size","pkfp","hashUnencrypted","hashEncrypted","signUnencrypted","signEncrypted","link","metaID","messageID","hashAlgorithm"];t<n.length;t++){var i=n[t];if(!e.hasOwnProperty(i))throw"Attachment verifyFileInfo: Missing required property: "+i}}},{key:"parseLink",value:function(e){var t=new g;t.addBlob("l",e).base64Decode("l","lres");var n=t.get("lres").split("/");return{residence:n[0],pkfp:n[1],name:n[2]}}}]),e}();K.properties=["name","size","type","lastModified","hashUnencrypted","signUnencrypted","hashEncrytped","signEncrypted","link","metaID","messageID","hashAlgorithm"];var _=function(){function e(t){l()(this,e),"string"==typeof t&&(t=JSON.parse(t)),this.signature=t?t.signature:"",this.header=t?t.header:{id:this.generateNewID(),timestamp:new Date,metadataID:"",author:"",nickname:"",recipient:"all"},this.body=t?t.body:"",this.attachments=t?t.attachments:void 0}return d()(e,[{key:"encryptMessage",value:function(e){var t=new g;t.setSYMKey("k",e).addBlob("body",this.body).AESEncrypt("body","k","bodycip",!0,"CBC","utf8"),this.attachments&&(t.addBlob("attachments",JSON.stringify(this.attachments)).AESEncrypt("attachments","k","attachmentscip",!0,void 0,"utf8"),this.attachments=t.get("attachmentscip")),this.header.nickname&&(t.addBlob("nname",this.header.nickname).AESEncrypt("nname","k","nnamecip",!0,"CBC","utf8"),this.header.nickname=t.get("nnamecip")),this.body=t.get("bodycip")}},{key:"encryptPrivateMessage",value:function(e){var t=new g;t.sym.createKey("sym").addBlob("body",this.body).AESEncrypt("body","sym","bodycip",!0,"CBC","utf8"),this.header.nickname&&(t.addBlob("nname",this.header.nickname).AESEncrypt("nname","sym","nnamecip",!0,"CBC","utf8"),this.header.nickname=t.get("nnamecip")),this.body=t.get("bodycip"),this.header.keys={},this.header.private=!0;var n=!0,i=!1,r=void 0;try{for(var s,a=e[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var o=s.value,c=new g;c.asym.setKey("pubk",o,"public").addBlob("sym",t.get("sym")).asym.encrypt("sym","pubk","symcip","hex").getPublicKeyFingerprint("pubk","pkfp"),this.header.keys[c.get("pkfp")]=c.get("symcip")}}catch(e){i=!0,r=e}finally{try{n||null==a.return||a.return()}finally{if(i)throw r}}}},{key:"decryptPrivateMessage",value:function(e){try{var t=new g;t.asym.setKey("priv",e,"private").publicFromPrivate("priv","pub").getPublicKeyFingerprint("pub","pkfp").addBlob("symcip",this.header.keys[t.get("pkfp")]).asym.decrypt("symcip","priv","sym","hex").addBlob("bodycip",this.body).sym.decrypt("bodycip","sym","body",!0,"CBC","utf8"),this.body=t.get("body"),this.header.nickname&&(t.addBlob("nnamecip",this.header.nickname).AESDecrypt("nnamecip","sym","nname",!0,"CBC","utf8"),this.header.nickname=t.get("nname"))}catch(e){console.log("Error decrypting private message: "+e)}}},{key:"decryptMessage",value:function(e){try{var t=new g;t.sym.setKey("k",e).addBlob("bodycip",this.body).sym.decrypt("bodycip","k","body",!0),this.body=t.get("body"),this.attachments&&(t.addBlob("attachmentscip",this.attachments).AESDecrypt("attachmentscip","k","attachments",!0,"CBC","utf8"),this.attachments=JSON.parse(t.get("attachments"))),this.header.nickname&&(t.addBlob("nnamecip",this.header.nickname).AESDecrypt("nnamecip","k","nname",!0,"CBC","utf8"),this.header.nickname=t.get("nname"))}catch(e){console.log("Error decrypting message: "+e)}}},{key:"addAttachmentInfo",value:function(e){this.attachments||(this.attachments=[]),K.verifyFileInfo(e),this.attachments.push(e)}},{key:"sign",value:function(e){var t=new g,n=JSON.stringify(this.header)+JSON.stringify(this.body);this.attachments&&(n+=JSON.stringify(this.attachments)),t.addBlob("body",n).setRSAKey("priv",e,"private").privateKeySign("body","priv","sign"),this.signature=t.get("sign")}},{key:"verify",value:function(e){var t=new g,n=JSON.stringify(this.header)+JSON.stringify(this.body);return this.attachments&&(n+=JSON.stringify(this.attachments)),t.setRSAKey("pubk",e,"public").addBlob("sign",this.signature).addBlob("b",n).publicKeyVerify("b","sign","pubk","v"),t.get("v")}},{key:"getNonce",value:function(e){var t=new g;return t.createNonce("n",e?parseInt(e):8).bytesToHex("n","nh"),t.get("nh")}},{key:"generateNewID",value:function(){return this.getNonce(8)}},{key:"toBlob",value:function(){return JSON.stringify(this)}}]),e}(),C=function(){function e(){l()(this,e)}return d()(e,null,[{key:"decryptStandardMessage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Err.required(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Err.required(),n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4,i=parseInt(e.substr(e.length-n)),r=e.substring(e.length-n-i,e.length-n),s=e.substring(0,e.length-n-i),a=new g;return a.addBlob("blobcip",s).addBlob("symkcip",r).asym.setKey("privk",t,"private").privateKeyDecrypt("symkcip","privk","symk","hex").AESDecrypt("blobcip","symk","blob-raw",!0,"CBC","utf8"),a.get("blob-raw")}},{key:"encryptStandardMessage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Err.required(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Err.required(),n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4,i=new g;return i.sym.createKey("symk").addBlob("payload",e).asym.setKey("pubk",t,"public").AESEncrypt("payload","symk","blobcip",!0,"CBC","utf8").asym.encrypt("symk","pubk","symcip","hex").encodeBlobLength("symcip",n,"0","symciplength").merge(["blobcip","symcip","symciplength"],"res"),i.get("res")}},{key:"publicKeyEncrypt",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Err.required(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Err.required(),n=new g;return n.addBlob("blob",e).asym.setKey("pubk",t,"public").publicKeyEncrypt("blob","pubk","blobcip","hex"),n.get("blobcip")}},{key:"privateKeyDecrypt",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"hex",i=new g;return i.addBlob("blobcip",e).asym.setKey("priv",t,"private").privateKeyDecrypt("blobcip","priv","blob",n),i.get("blob")}},{key:"symKeyEncrypt",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=new g;return i.addBlob("b",e).sym.setKey("sym",t).AESEncrypt("b","sym","cip",n,"CBC","utf8"),i.get("cip")}},{key:"symKeyDecrypt",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=new g;return i.addBlob("cip",e).sym.setKey("sym",t).AESDecrypt("cip","sym","b",n,"CBC","utf8"),i.get("b")}}]),e}(),M=function(){function e(t,n){if(l()(this,e),void 0===t||""===t)throw"Message init error: Software version is required!";"string"==typeof n&&(n=JSON.parse(n)),this.headers=n?this.copyHeaders(n.headers):{command:"",response:"",version:t},this.body=n?n.body:{},this.signature=n?n.signature:""}return d()(e,[{key:"setError",value:function(e){this.headers.error=e||"Unknown error"}},{key:"setResponse",value:function(e){this.headers.response=e}},{key:"copyHeaders",value:function(e){for(var t={},n=Object.keys(e),i=0;i<n.length;++i)t[n[i]]=e[n[i]];return t}},{key:"setVersion",value:function(e){if(void 0===e||""===e)throw"Error setting message version: version undefined";this.headers.version=e}},{key:"signMessage",value:function(e){var t=new g,n=JSON.stringify(this.headers)+JSON.stringify(this.body);t.addBlob("body",n).setRSAKey("priv",e,"private").privateKeySign("body","priv","sign"),this.signature=t.get("sign")}},{key:"setSource",value:function(e){this.headers.pkfpSource=e}},{key:"setDest",value:function(e){this.headers.pkfpDest=e}},{key:"setCommand",value:function(e){this.headers.command=e}},{key:"addNonce",value:function(){var e=new g;e.createNonce("n").bytesToHex("n","nhex"),this.headers.nonce=e.get("nhex")}},{key:"get",value:function(e){if(this.keyExists(e))return this[e];throw"Property not found"}},{key:"set",value:function(t,n){if(!e.properties.includes(t))throw'Invite: invalid property "'+t+'"';this[t]=n}}],[{key:"verifyMessage",value:function(e,t){var n=new g,i=JSON.stringify(t.headers)+JSON.stringify(t.body);return n.setRSAKey("pubk",e,"public").addBlob("sign",t.signature).hexToBytes("sign","signraw").addBlob("b",i),n.publicKeyVerify("b","sign","pubk","v"),n.get("v")}}]),e}();M.properties=["headers","body","signature"];var x=function(){function e(){l()(this,e)}return d()(e,null,[{key:"parseMetadata",value:function(e){return"string"==typeof e?JSON.parse(e):e}},{key:"extractSharedKey",value:function(e,t,n){var i=n.body.participants[e].key,r=new g;return r.addBlob("symcip",i).asym.setKey("priv",t,"private").asym.decrypt("symcip","priv","sym","hex"),r.get("sym")}},{key:"isMetadataValid",value:function(e,t){}}]),e}(),A=function(){function e(t){l()(this,e),t&&this.parseBlob(t)}return d()(e,null,[{key:"objectValid",value:function(t){if("string"==typeof t)return!1;for(var n=0;n<e.properties.length;++n)if(!t.hasOwnProperty(e.properties[n]))return!1;return Object.keys(t).length===e.properties.length}}]),d()(e,[{key:"toBlob",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this.readyForExport())throw"Object participant has some properties uninitialized";for(var n={},i=0;i<e.properties.length;++i){var r=e.properties[i],s=this[e.properties[i]];console.log("Key: "+r+"; Value: "+s),n[e.properties[i]]=this[e.properties[i]]}return t?JSON.stringify(n):n}},{key:"parseBlob",value:function(t){if(!t)throw"missing required parameter";if("string"==typeof t&&(t=JSON.parse(t)),!this.objectValid(t))throw"Participant blob is invalid";for(var n=0;n<e.properties.length;++n)this[e.properties[n]]=t[e.properties[n]]}},{key:"keyExists",value:function(e){if(!e)throw"keyExists: Missing required arguments";return Object.keys(this).includes(e.toString())}},{key:"readyForExport",value:function(){for(var t=0;t<e.properties;++t)if(!this[e.properties[t]])return!1;return!0}},{key:"get",value:function(e){if(this.keyExists(e))return this[e];throw"Property not found"}},{key:"set",value:function(t,n){if(!e.properties.includes(t))throw'Participant: invalid property "'+t+'"';this[t]=n}}]),e}();A.properties=["nickname","publicKey","publicKeyFingerprint","residence","rights"];var R=function e(){l()(this,e),this.nicknames={},this.invites={}},q=n(90);function N(){}N.mixin=function(e){var t=e.prototype||e;t.isWildEmitter=!0,t.on=function(e,t,n){this.callbacks=this.callbacks||{};var i=3===arguments.length,r=i?arguments[1]:void 0,s=i?arguments[2]:arguments[1];return s._groupName=r,(this.callbacks[e]=this.callbacks[e]||[]).push(s),this},t.once=function(e,t,n){var i=this,r=3===arguments.length,s=r?arguments[1]:void 0,a=r?arguments[2]:arguments[1];function o(){i.off(e,o),a.apply(this,arguments)}return this.on(e,s,o),this},t.releaseGroup=function(e){var t,n,i,r;for(t in this.callbacks=this.callbacks||{},this.callbacks)for(n=0,i=(r=this.callbacks[t]).length;n<i;n++)r[n]._groupName===e&&(r.splice(n,1),n--,i--);return this},t.off=function(e,t){this.callbacks=this.callbacks||{};var n,i=this.callbacks[e];return i?1===arguments.length?(delete this.callbacks[e],this):(n=i.indexOf(t),i.splice(n,1),0===i.length&&delete this.callbacks[e],this):this},t.emit=function(e){this.callbacks=this.callbacks||{};var t,n,i,r=[].slice.call(arguments,1),s=this.callbacks[e],a=this.getWildcardCallbacks(e);if(s)for(t=0,n=(i=s.slice()).length;t<n&&i[t];++t)i[t].apply(this,r);if(a)for(n=a.length,t=0,n=(i=a.slice()).length;t<n&&i[t];++t)i[t].apply(this,[e].concat(r));return this},t.getWildcardCallbacks=function(e){this.callbacks=this.callbacks||{};var t,n,i=[];for(t in this.callbacks)n=t.split("*"),("*"===t||2===n.length&&e.slice(0,n[0].length)===n[0])&&(i=i.concat(this.callbacks[t]));return i}},N.mixin(N);var T,P=function(){function e(t){if(l()(this,e),!t.version)throw"Version required!";this.version=t.version,this.islandConnectionStatus=!1,this.allMessagesLoaded=!1,this.loadingMessages=!1,this.chatSocket=null,this.fileSocket=null,this.transport=t.transport||0,this.session=null,this.newTopicPending={},this.pendingTopicJoins={},this.outgoingMessageQueue={},this.attachmentsUploadQueue={},this.setClientHandlers(),N.mixin(this)}var t,n,i,r,a,c,u,p;return d()(e,[{key:"setClientHandlers",value:function(){this.responseHandlers={init_topic_get_token_success:this.initTopicContinueAfterTokenReceived,init_topic_success:this.initTopicSuccess,login_decryption_required:this.loginDecryptData,join_topic_success:this.notifyJoinSuccess,login_success:this.finalizeLogin,update_settings_success:this.onSuccessfullSettingsUpdate,load_more_messages_success:this.loadMoreMessagesSuccess,request_invite_success:this.processInviteCreated,request_invite_error:this.requestInviteError,sync_invites_success:this.syncInvitesSuccess,save_invite_success:this.saveInviteSuccess,update_invite_success:this.updateInviteSuccess,send_success:this.messageSendSuccess,del_invite_success:this.delInviteSuccess,boot_participant_failed:this.bootParticipantFailed,send_fail:this.messageSendFail,delete_topic_success:this.deleteTopicSuccess,default:this.processInvalidResponse},this.serviceMessageHandlers={metadata_issue:this.processMetadataUpdate,meta_sync:this.processMetadataUpdate,u_booted:this.uWereBooted,whats_your_name:this.processNicknameRequest,my_name_response:this.processNicknameResponse,nickname_change_broadcast:this.processNicknameChangeNote,default:this.processUnknownNote},this.messageHandlers={shout_message:this.processIncomingMessage,whisper_message:this.processIncomingMessage},this.requestHandlers={new_member_joined:this.processNewMemberJoined},this.requestErrorHandlers={login_error:this.loginFail,init_topic_error:this.initTopicFail,request_invite_error:this.requestInviteError,sync_invites_error:this.syncInvitesError,delete_topic_error:this.deleteTopicError,join_topic_error:this.joinTopicError,default:this.unknownError}}},{key:"processServiceMessage",value:function(e){this.serviceMessageHandlers.hasOwnProperty(e.headers.command)?this.serviceMessageHandlers[e.headers.command](e,this):this.serviceMessageHandlers.default(e,this)}},{key:"processServiceRecord",value:function(e,t){console.log("New service record arrived!"),e.body=C.decryptStandardMessage(e.body,t.session.privateKey),t.emit("service_record",e)}},{key:"processResponse",value:function(e){(e=new M(self.version,e)).headers.error?this.requestErrorHandlers.hasOwnProperty(e.headers.response)?this.requestErrorHandlers[e.headers.response](e,this):this.requestErrorHandlers.default(e,this):this.responseHandlers.hasOwnProperty(e.headers.response)?this.responseHandlers[e.headers.response](e,this):this.responseHandlers.default(e,this)}},{key:"processRequest",value:function(e){this.requestHandlers.hasOwnProperty(e.headers.command)?this.requestHandlers[e.headers.command](e,this):this.requestErrorHandlers.default(e,this)}},{key:"processUnknownNote",value:function(e,t){console.log("UNKNOWN NOTE RECEIVED!\n"+JSON.stringify(e)),t.emit("unknown_note",e)}},{key:"initTopic",value:function(e,t){var n=this;return new Promise(function(){var i=o()(s.a.mark((function i(r,a){var o,c,l,u,d;return s.a.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(i.prev=0,o=n,(e=String(e).trim())&&!(e.length<3)){i.next=6;break}return a("Nickname entered is invalid"),i.abrupt("return");case 6:return c=new g,i.next=9,c.asym.asyncCreateKeyPair("owner-keys");case 9:return c=i.sent,i.next=12,c.asym.asyncCreateKeyPair("topic-keys");case 12:return(c=i.sent).getPublicKeyFingerprint("owner-keys","owner-pkfp"),c.getPublicKeyFingerprint("topic-keys","topic-pkfp"),l={ownerKeyPair:c.get("owner-keys"),topicKeyPair:c.get("topic-keys"),ownerPkfp:c.get("owner-pkfp"),topicID:c.get("topic-pkfp"),ownerNickName:e,topicName:t},(u=new M(o.version)).headers.command="new_topic_get_token",d={topicID:l.topicID,ownerPublicKey:c.get("owner-keys").publicKey},u.set("body",d),o.newTopicPending[l.topicID]=l,console.log("Establishing connection"),i.next=24,n.establishIslandConnection();case 24:n.chatSocket.emit("request",u),r(),i.next=31;break;case 28:throw i.prev=28,i.t0=i.catch(0),i.t0;case 31:case"end":return i.stop()}}),i,null,[[0,28]])})));return function(e,t){return i.apply(this,arguments)}}())}},{key:"initTopicContinueAfterTokenReceived",value:function(e,t){console.log("Token received, continuing creating topic");var n=t.newTopicPending[e.body.topicID],i=e.body.token,r={topicKeyPair:n.topicKeyPair,ownerPublicKey:n.ownerKeyPair.publicKey},s=C.encryptStandardMessage(JSON.stringify(r),i),a=t.prepareNewTopicSettings(n.ownerNickName,n.topicName,n.ownerKeyPair.publicKey),o=new M(t.version);o.headers.command="init_topic",o.headers.pkfpSource=n.ownerPkfp,o.body.topicID=n.topicID,o.body.settings=a,o.body.ownerPublicKey=n.ownerKeyPair.publicKey,o.body.newTopicData=s,t.chatSocket.emit("request",o)}},{key:"prepareNewTopicSettings",value:function(e,t,n){var i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],r={version:version,membersData:{},soundsOn:!0};if(e){var s=new g;s.asym.setKey("pubk",n,"public").getPublicKeyFingerprint("pubk","pkfp"),r.nickname=e,r.membersData[s.get("pkfp")]={nickname:e}}return t&&(r.topicName=t),i?C.encryptStandardMessage(JSON.stringify(r),n):r}},{key:"initTopicSuccess",value:function(e,t){var n=t.newTopicPending[e.body.topicID];n.pkfp,n.privateKey,n.nickname;t.emit("init_topic_success",{pkfp:n.ownerPkfp,nickname:n.ownerNickName,privateKey:n.ownerKeyPair.privateKey}),delete t.newTopicPending[e.body.topicID]}},{key:"topicLogin",value:(p=o()(s.a.mark((function e(t){var n,i,r,a,o;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=!0,t=String(t).trim(),!this.session||"active"!==this.session.status||!this.islandConnectionStatus){e.next=5;break}return this.emit("login_success"),e.abrupt("return");case 5:return e.prev=5,e.next=8,this.establishIslandConnection();case 8:(r=new g).setRSAKey("pk",t,"private").publicFromPrivate("pk","pub").getPublicKeyFingerprint("pub","pkfp").createNonce("nonce").bytesToHex("nonce","noncehex"),this.session={sessionID:r.get("noncehex"),publicKey:r.get("pub"),privateKey:r.get("pk"),publicKeyFingerprint:r.get("pkfp"),status:"off"},a={publicKey:r.get("pub"),sessionID:r.get("noncehex")},(o=new M(self.version)).set("body",a),o.headers.command="init_login",o.headers.pkfpSource=r.get("pkfp"),o.signMessage(r.get("pk")),this.chatSocket.emit("request",o),e.next=24;break;case 20:e.prev=20,e.t0=e.catch(5),n=!1,i=e.t0.message;case 24:if(n){e.next=36;break}return e.prev=25,e.next=28,this.terminateIslandConnection();case 28:e.next=33;break;case 30:e.prev=30,e.t1=e.catch(25),console.log("ERROR terminating island connection: "+e.t1);case 33:return e.prev=33,this.emit("login_fail",i),e.finish(33);case 36:case"end":return e.stop()}}),e,this,[[5,20],[25,30,33,36]])}))),function(e){return p.apply(this,arguments)})},{key:"loginDecryptData",value:function(e,t){var n=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4,i=new g,r=parseInt(t.substr(-n)),s=t.length,a=t.substring(s-r-n,s-n),o=t.substring(0,s-r-n);return i.addBlob("symcip",a).addBlob("cipher",o).asym.setKey("priv",e,"private").asym.decrypt("symcip","priv","sym","hex").sym.decrypt("cipher","sym","blob-raw",!0),i.get("blob-raw")},i=function(e,t){arguments.length>2&&void 0!==arguments[2]&&arguments[2];var n=new g;return n.createSYMKey("sym").asym.setKey("pub",e,"public").addBlob("blob-raw",t).sym.encrypt("blob-raw","sym","blob-cip",!0).asym.encrypt("sym","pub","symcip","hex").encodeBlobLength("symcip",4,"0","symcipl").merge(["blob-cip","symcip","symcipl"],"res"),n.get("res")};if(t.session){var r,s,a,o=e.body.token,c=e.body.dataForDecryption;(new g).asym.setKey("priv",t.session.privateKey,"private"),c.clientHSPrivateKey&&(r=n(t.session.privateKey,c.clientHSPrivateKey)),c.topicAuthority&&c.topicAuthority.taPrivateKey&&(s=n(t.session.privateKey,c.topicAuthority.taPrivateKey)),c.topicAuthority&&c.topicAuthority.taHSPrivateKey&&(a=n(t.session.privateKey,c.topicAuthority.taHSPrivateKey));var l={};r&&(l.clientHSPrivateKey=i(o,r)),(s||a)&&(l.topicAuthority={}),s&&(l.topicAuthority.taPrivateKey=i(o,s)),a&&(l.topicAuthority.taHSPrivateKey=i(o,a));var u=new M(t.version);u.headers.pkfpSource=t.session.publicKeyFingerprint,u.body=e.body,u.body.preDecrypted=l,u.headers.command="login_decrypted_continue",u.signMessage(t.session.privateKey),console.log("Decryption successfull. Sending data back to Island"),t.chatSocket.emit("request",u)}else console.log("invalid island request")}},{key:"finalizeLogin",value:function(e,t){var n=x.parseMetadata(e.body.metadata),i=x.extractSharedKey(t.session.publicKeyFingerprint,t.session.privateKey,n),r=t.decryptMessagesOnMessageLoad(e.body.messages),s=n.body.settings?n.body.settings:{};t.session.status="active",t.session.metadata=n.body,t.session.metadata.sharedKey=i,t.session.metadataSignature=n.signature,t.session.settings=JSON.parse(C.decryptStandardMessage(s,t.session.privateKey)),t.emit("login_success",r),t.checkNicknames()}},{key:"checkNicknames",value:function(){for(var e=0,t=Object.keys(this.session.metadata.participants);e<t.length;e++){var n=t[e];this.getMemberNickname(n)||this.requestNickname(n)}}},{key:"getMemberNickname",value:function(e){if(this.session&&e){var t=this.session.settings.membersData;return t[e]?t[e].nickname:void 0}}},{key:"getMemberAlias",value:function(e){if(this.session&&e){var t=this.session.settings.membersData;return t[e]&&t[e].alias?t[e].alias:e.substring(0,8)}}},{key:"deleteMemberAlias",value:function(e){var t=this.session.settings.membersData;t[e]&&delete t[e].alias}},{key:"getMemberRepr",value:function(e){if(this.session.settings.membersData[e])return this.getMemberAlias(e)||this.getMemberNickname(e)||"Anonymous"}},{key:"deleteMemberData",value:function(e){delete this.session.settings.membersData[e]}},{key:"setMemberNickname",value:function(e,t,n){if(n)n.membersData[e]={joined:new Date,nickname:t};else{if(!e)throw"Missing required parameter";var i=this.session.settings.membersData;i[e]||this.addNewMemberToSettings(e),i[e].nickname=t}}},{key:"setMemberAlias",value:function(e,t){if(!e)throw"Missing required parameter";if(this.session){var n=this.session.settings.membersData;n[e]||(n[e]={}),t?n[e].alias=t:delete n[e].alias}}},{key:"requestNickname",value:function(e){if(!e)throw"Missing required parameter";var t=new M(self.version);t.setCommand("whats_your_name"),t.setSource(this.session.publicKeyFingerprint),t.setDest(e),t.addNonce(),t.signMessage(this.session.privateKey),this.chatSocket.emit("request",t)}},{key:"broadcastNameChange",value:function(){var e=new M(this.version);e.setCommand("nickname_change_broadcast"),e.setSource(this.session.publicKeyFingerprint),e.addNonce(),e.body.nickname=C.symKeyEncrypt(this.session.settings.nickname,this.session.metadata.sharedKey),e.signMessage(this.session.privateKey),this.chatSocket.emit("request",e)}},{key:"processNicknameResponse",value:function(e,t){t._processNicknameResponseHelper(e,t)}},{key:"processNicknameChangeNote",value:function(e,t){t._processNicknameResponseHelper(e,t,!0)}},{key:"_processNicknameResponseHelper",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];console.log("Got nickname response");var i=t.session.metadata.participants[e.headers.pkfpSource].publicKey;if(M.verifyMessage(i,e)){var r=t.getMemberNickname(e.headers.pkfpSource),s=t.getMemberRepr(e.headers.pkfpSource),a=n?C.symKeyDecrypt(e.body.nickname,t.session.metadata.sharedKey):C.decryptStandardMessage(e.body.nickname,t.session.privateKey);(a=a.toString("utf8"))!==r&&(t.setMemberNickname(e.headers.pkfpSource,a),t.saveClientSettings(),r&&""!==r&&t.createServiceRecordOnMemberNicknameChange(s,a,e.headers.pkfpSource))}else console.trace("Invalid signature")}},{key:"createServiceRecordOnMemberNicknameChange",value:function(e,t,n){var i="Member "+(e=e||"")+" (id: "+n+") changed nickname to: "+t;this.createRegisterServiceRecord("member_nickname_change",i)}},{key:"createRegisterServiceRecord",value:function(e,t){var n=new M(self.version);n.addNonce(),n.setSource(this.session.publicKeyFingerprint),n.setCommand("register_service_record"),n.body.event=e,n.body.message=C.encryptStandardMessage(t,this.session.publicKey),n.signMessage(this.session.privateKey),this.chatSocket.emit("request",n)}},{key:"processNicknameRequest",value:function(e,t){var n=new M(t.version,e),i=t.session.metadata.participants[e.headers.pkfpSource].publicKey;if(M.verifyMessage(i,n)){var r=new M(t.version);r.setCommand("my_name_response"),r.setSource(t.session.publicKeyFingerprint),r.setDest(e.headers.pkfpSource),r.addNonce(),r.body.nickname=C.encryptStandardMessage(t.session.settings.nickname,i),r.signMessage(t.session.privateKey),t.chatSocket.emit("request",r)}else console.trace("Invalid signature")}},{key:"addNewMemberToSettings",value:function(e){this.session.settings.membersData[e]={joined:new Date}}},{key:"attemptReconnection",value:(u=o()(s.a.mark((function e(){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("Attempt reconnection called in Chat"),e.next=3,this.topicLogin(this.session.privateKey);case 3:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"loadMoreMessages",value:function(e){var t=new M(self.version);t.headers.command="load_more_messages",t.headers.pkfpSource=this.session.publicKeyFingerprint,t.body.lastLoadedMessageID=e,t.signMessage(this.session.privateKey),this.chatSocket.emit("request",t)}},{key:"loadMoreMessagesSuccess",value:function(e,t){var n=t.decryptMessagesOnMessageLoad(e.body.lastMessages);t.emit("messages_loaded",n),t.loadingMessages=!0}},{key:"decryptMessagesOnMessageLoad",value:function(e){for(var t=e.keys,n=Object.keys(t),i=0;i<n.length;++i){var r=new g;r.addBlob("k",t[n[i]]).hexToBytes("k","kraw").setRSAKey("priv",this.session.privateKey,"private").privateKeyDecrypt("kraw","priv","kdec"),t[n[i]]=r.get("kdec")}for(var s=e.messages,a=[],o=0;o<s.length;++o){var c=new _(s[o]);c.header.service?c.body=C.decryptStandardMessage(c.body,this.session.privateKey):c.header.private?c.decryptPrivateMessage(this.session.privateKey):c.decryptMessage(t[c.header.metadataID]),a.push(c)}return a}},{key:"logout",value:function(){this.chatSocket.disconnect(),this.chatSocket.off(),this.session=null,this.allMessagesLoaded=!1}},{key:"haveIRightsToBoot",value:function(){return parseInt(this.session.metadata.participants[this.session.publicKeyFingerprint].rights)>=3}},{key:"bootParticipant",value:function(e){if(this.haveIRightsToBoot()){var t=new M(this.version);t.headers.command="boot_participant",t.headers.pkfpSource=this.session.publicKeyFingerprint,t.headers.pkfpDest=this.session.metadata.topicAuthority.pkfp,t.body.pkfp=e,t.signMessage(this.session.privateKey),this.chatSocket.emit("request",t)}else this.emit("boot_participant_fail","Not enough rights to boot a member")}},{key:"noteParticipantBooted",value:function(e,t){console.log("Note received: A member has been booted. Processing");var n=x.parseMetadata(e.body.metadata);t._updateMetadata(n);var i=this.getMemberRepr(e.body.bootedPkfp);this.deleteMemberData(e.body.bootedPkfp),this.saveClientSettings(),t.emit("participant_booted","Participant "+i+" has been booted!")}},{key:"bootParticipantFailed",value:function(e,t){console.log("Boot member failed!"),t.emit("boot_participant_fail",e.error)}},{key:"initTopicJoin",value:(c=o()(s.a.mark((function e(t,n){var i,r,a,o,c,l,u,d,p,h,y,v,f;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=new Date,console.log("joining topic with nickname: "+t+" | Invite code: "+n),new R,e.next=5,this.establishIslandConnection();case 5:if(console.log("Connection with island is established. ".concat((new Date-i)/1e3," Elapsed since beginning. Working crypto.")),r=new Date,(a=new g).asym.createKeyPair("rsa").getPublicKeyFingerprint("rsa","pkfp").addBlob("invite64",n.trim()).base64Decode("invite64","invite"),o=new Date,console.log("Keys generated in ".concat((o-r)/1e3,"sec. ").concat((o-i)/1e3," elapsed since beginning.")),c=a.get("invite").split("/"),l=c[0],u=c[1],d=c[2],this.inviteRequestValid(l,u,d)){e.next=18;break}throw this.emit("join_topic_fail"),"Invite request is invalid";case 18:return this.pendingTopicJoins[d]={pkfp:a.get("pkfp"),publicKey:a.get("rsa").publicKey,privateKey:a.get("rsa").privateKey,nickname:t,inviterID:u,inviterResidence:l},p={command:"join_topic",pkfpDest:u,pkfpSource:a.get("pkfp")},h={inviteString:n.trim(),inviteCode:d,destination:l,invitee:{publicKey:a.get("rsa").publicKey,nickname:t,pkfp:a.get("pkfp")}},(y=new M(self.version)).set("headers",p),y.set("body",h),y.signMessage(a.get("rsa").privateKey),console.log("Sending topic join request"),v=new Date,this.chatSocket.emit("request",y),o=new Date,console.log("Request sent to island in  ".concat((o-v)/1e3,"sec. ").concat((o-i)/1e3," elapsed since beginning.")),f={newPublicKey:a.get("rsa").publicKey,newPrivateKey:a.get("rsa").privateKey},e.abrupt("return",f);case 32:case"end":return e.stop()}}),e,this)}))),function(e,t){return c.apply(this,arguments)})},{key:"initSettingsOnTopicJoin",value:function(e,t){var n=e.privateKey,i=e.publicKey,r=new g;r.asym.setKey("pub",i,"public").getPublicKeyFingerprint("pub","pkfp");r.get("pkfp");var s=C.decryptStandardMessage(t.body.topicName,n),a=C.decryptStandardMessage(t.body.inviterNickname,n),o=t.body.inviterPkfp,c=this.prepareNewTopicSettings(e.nickname,s,e.publicKey,!1);this.setMemberNickname(o,a,c),this.saveClientSettings(c,n)}},{key:"onSuccessfullSettingsUpdate",value:function(e,t){console.log("Settings successfully updated!"),t.emit("settings_updated")}},{key:"notifyJoinSuccess",value:function(e,t){console.log("Join successfull received!");var n=t.pendingTopicJoins[e.body.inviteCode];t.initSettingsOnTopicJoin(n,e),console.log("new topic pkfp: "+JSON.stringify(n)),t.emit("topic_join_success",{pkfp:n.pkfp,nickname:n.nickname,privateKey:n.privateKey})}},{key:"saveClientSettings",value:function(e,t){e||(e=this.session.settings),t||(t=this.session.privateKey);var n=new g;n.asym.setKey("privk",t,"private").publicFromPrivate("privk","pub").getPublicKeyFingerprint("pub","pkfp");var i=n.get("pub"),r=n.get("pkfp");"object"==typeof e&&(e=JSON.stringify(e));var s={command:"update_settings",pkfpSource:r},a={settings:C.encryptStandardMessage(e,i)},o=new M(self.version);o.set("headers",s),o.set("body",a),o.signMessage(t),console.log("Sending update settings request"),this.chatSocket.emit("request",o)}},{key:"deleteTopic",value:(a=o()(s.a.mark((function e(){var t,n,i,r;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.session){e.next=2;break}throw"User must be logged in";case 2:t=this.session.privateKey,(n=new g).createNonce("n").bytesToHex("n","nhex"),i={command:"delete_topic",pkfpSource:this.session.publicKeyFingerprint,nonce:n.get("nhex")},(r=new M(self.version)).set("headers",i),r.signMessage(t),this.chatSocket.emit("request",r);case 10:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"deleteTopicSuccess",value:function(e,t){console.log("Delete topic successful"),t.logout(),t.emit("delete_topic_success")}},{key:"deleteTopicError",value:function(e,t){console.log("Delete topic error"),t.emit("delete_topic_error")}},{key:"uWereBooted",value:function(e,t){console.log("Looks like I am being booted. Checking.."),M.verifyMessage(t.session.metadata.topicAuthority.publicKey,e)?(t.session.metadata.status="sealed",console.log("You have been booted"),t.emit("u_booted","You have been excluded from this channel.")):console.log("Probably it was a mistake")}},{key:"updateMetaOnNewMemberJoin",value:function(e,t){t.session.metadata=JSON.parse(e.body.metadata),t.emit("new_member_joined")}},{key:"loginFail",value:function(e,t){console.log("Emiting login fail... "+e.headers.error),t.emit("login_fail",e.headers.error)}},{key:"initTopicFail",value:function(e,t){console.log("Init topic fail: "+e.headers.error),t.emit("init_topic_error",e.headers.error)}},{key:"unknownError",value:function(e,t){console.log("Unknown request error: "+e.headers.response),t.emit("unknown_error",e.headers.error)}},{key:"processInvalidResponse",value:function(e,t){console.log("Received invalid server response"),t.emit("invalid_response",e)}},{key:"addNewParticipant",value:function(e,t,n,i){var r=new g;r.setRSAKey("pk",t,"public").getPublicKeyFingerprint("pk","fp");var s=new A;s.set("nickname",e),s.set("publicKey",r.get("pk")),s.set("publicKeyFingerprint",r.get("fp")),s.set("residence",n),s.set("rights",i),this.session.metadata.addParticipant(s),this.broadcastMetadataUpdate()}},{key:"uploadAttachments",value:function(e,t,n){var i=this;return new Promise(function(){var r=o()(s.a.mark((function r(a,o){var c,l,u,d,p,h,y,v,g,f,m,b,k;return s.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(c=i,void 0!==Worker){r.next=4;break}return o(null,"Client does not support web workers."),r.abrupt("return");case 4:for(l=[],u=c.session.publicKeyFingerprint,d=c.session.privateKey,p=c.session.metadata.sharedKey,h=c.session.metadata.participants[c.session.publicKeyFingerprint].residence,y=!0,v=!1,g=void 0,r.prev=12,f=e[Symbol.iterator]();!(y=(m=f.next()).done);y=!0)b=m.value,console.log("Calling worker function"),l.push(c.uploadAttachmentWithWorker(b,u,d,p,t,n,h));r.next=20;break;case 16:r.prev=16,r.t0=r.catch(12),v=!0,g=r.t0;case 20:r.prev=20,r.prev=21,y||null==f.return||f.return();case 23:if(r.prev=23,!v){r.next=26;break}throw g;case 26:return r.finish(23);case 27:return r.finish(20);case 28:return r.prev=28,r.next=31,Promise.all(l);case 31:k=r.sent,a(k),r.next=39;break;case 35:r.prev=35,r.t1=r.catch(28),console.log("ERROR DURING UPLOAD ATTACHMENTS: "+r.t1),o(r.t1);case 39:case"end":return r.stop()}}),r,null,[[12,16,20,28],[21,,23,27],[28,35]])})));return function(e,t){return r.apply(this,arguments)}}())}},{key:"uploadAttachmentWithWorker",value:function(e,t,n,i,r,s,a){return new Promise((function(o,c){console.log("!!!Initializing worker...");var l=new Worker("/js/uploaderWorker.js"),u={upload_complete:function(i){var c=new K(e,a,t,s,n,r,i.hashEncrypted,i.hashUnencrypted);l.terminate(),o(c)},upload_progress:function(e){},upload_error:function(e){l.terminate(),self.emit("upload_error",e.data),c(data)},log:function(e){console.log("WORKER LOG: "+e)}};l.onmessage=function(e){var t=e.data;u[t.result](t.data)},l.postMessage({command:"upload",attachment:e,pkfp:t,privk:n,symk:i})}))}},{key:"downloadAttachment",value:function(e){var t=this;return new Promise(function(){var n=o()(s.a.mark((function n(i,r){var a,o,c,l,u,d,p;return s.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(console.log("About to download the attachment"),n.prev=1,o=(a=t).session.privateKey,c=JSON.parse(e),l=a.session.metadata.participants[c.pkfp].publicKey,void 0!==Worker){n.next=12;break}u="Worker is not defined.Cannot download file.",console.log(u),r(u),n.next=19;break;case 12:return console.log("Downloading with worker or sync"),d=a.session.publicKeyFingerprint,n.next=16,a.downloadAttachmentSync(e,d,o,l,c.name);case 16:p=n.sent,a.emit("download_complete",{fileInfo:e,fileData:p}),i();case 19:n.next=24;break;case 21:n.prev=21,n.t0=n.catch(1),r(n.t0);case 24:case"end":return n.stop()}}),n,null,[[1,21]])})));return function(e,t){return n.apply(this,arguments)}}())}},{key:"downloadAttachmentWithWorker",value:function(e,t,n,i,r){var a=this;return new Promise(function(){var c=o()(s.a.mark((function o(c,l){var u,d,p,h;return s.a.wrap((function(s){for(;;)switch(s.prev=s.next){case 0:try{u=new Worker("/js/fileWorker.js"),d={download_complete:function(e){console.log("RECEIVED FILE BUFFER FROM THE WORKER: length: "+e.length),c(e),u.terminate()},download_failed:function(e){console.log("Download failed with error: "+e),l(e),u.terminate()},log:function(e){console.log("WORKER LOG: "+e)},file_available_locally:function(){a.emit("file_available_locally",r),p("File found locally.")},requesting_peer:function(){a.emit("requesting_peer",r),p("Requesting peer to hand the file...")}},p=function(e){console.log("FILE TRANSFER EVENT NOTIFICATION: "+e)},h=function(e){d[e.message](e.data)},u.onmessage=function(e){h(e.data)},u.onerror=function(e){console.log(e),l("Downloader worker error"),u.terminate()},u.postMessage({command:"download",data:{fileInfo:e,myPkfp:t,privk:n,pubk:i}})}catch(e){l(e)}case 1:case"end":return s.stop()}}),o)})));return function(e,t){return c.apply(this,arguments)}}())}},{key:"downloadAttachmentSync",value:function(e,t,n,i,r){console.log("Downloading attachment sync");var a=this;return new Promise(function(){var c=o()(s.a.mark((function o(c,l){var u,d,p,h;return s.a.wrap((function(s){for(;;)switch(s.prev=s.next){case 0:s.prev=0,u=new I,d={download_complete:function(e){console.log("RECEIVED FILE BUFFER FROM THE WORKER: length: "+e.length),c(e),u.terminate()},download_failed:function(e){console.log("Download failed with error: "+e),l(e),u.terminate()},log:function(e){console.log("WORKER LOG: "+e)},file_available_locally:function(){a.emit("file_available_locally",r),p("File found locally.")},requesting_peer:function(){a.emit("requesting_peer",r),p("Requesting peer to hand the file...")}},p=function(e){console.log("FILE TRANSFER EVENT NOTIFICATION: "+e)},h=function(e){d[e.message](e.data)},u.on("message",(function(e){h(e.data)})),u.on("error",(function(e){console.log(e),l("Downloader worker error"),u.terminate()})),s.prev=10,u.downloadFile({fileInfo:e,myPkfp:t,privk:n,pubk:i}),s.next=18;break;case 14:throw s.prev=14,s.t0=s.catch(10),console.log("Error downloading file: ".concat(s.t0)),s.t0;case 18:s.next=23;break;case 20:s.prev=20,s.t1=s.catch(0),l(s.t1);case 23:case"end":return s.stop()}}),o,null,[[0,20],[10,14]])})));return function(e,t){return c.apply(this,arguments)}}())}},{key:"prepareMessage",value:function(e,t,n){var i=this;return new Promise((function(r,s){if(void 0===e||""===e)throw"Chat message initialization error: Version is required";var a=i;console.log("Preparing message: "+t),a.isLoggedIn()||(a.emit("login_required"),s());var o=new _;o.version=e,o.header.metadataID=i.session.metadata.id,o.header.author=i.session.publicKeyFingerprint,o.header.recipient=n||"ALL",o.header.private=!!n,o.header.nickname=a.session.settings.nickname,o.body=t,r(o)}))}},{key:"shoutMessage",value:function(e,t){var n=this;return new Promise(function(){var i=o()(s.a.mark((function i(r,a){var o,c,l,u,d,p,h,y,v,g,f,m,b;return s.a.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.prev=0,l=(o=n).session.metadata.id,i.next=5,o.prepareMessage(n.version,e);case 5:if(u=i.sent,!(t&&t.length>0)){i.next=29;break}return i.next=9,o.uploadAttachments(t,u.header.id,l);case 9:for(c=i.sent,d=!0,p=!1,h=void 0,i.prev=13,y=c[Symbol.iterator]();!(d=(v=y.next()).done);d=!0)g=v.value,u.addAttachmentInfo(g);i.next=21;break;case 17:i.prev=17,i.t0=i.catch(13),p=!0,h=i.t0;case 21:i.prev=21,i.prev=22,d||null==y.return||y.return();case 24:if(i.prev=24,!p){i.next=27;break}throw h;case 27:return i.finish(24);case 28:return i.finish(21);case 29:u.encryptMessage(n.session.metadata.sharedKey),u.sign(n.session.privateKey),(f=new M(o.version)).headers.pkfpSource=n.session.publicKeyFingerprint,f.headers.command="broadcast_message",f.body.message=u.toBlob(),m=(new Date).getTime(),f.travelLog={},f.travelLog[m]="Outgoing processed on client.",b=n.session.privateKey,f.signMessage(b),n.chatSocket.emit("request",f),r(),i.next=47;break;case 44:i.prev=44,i.t1=i.catch(0),a(i.t1);case 47:case"end":return i.stop()}}),i,null,[[0,44],[13,17,21,29],[22,,24,28]])})));return function(e,t){return i.apply(this,arguments)}}())}},{key:"whisperMessage",value:function(e,t,n){var i=this;return new Promise(function(){var n=o()(s.a.mark((function n(r,a){var o,c,l,u,d;return s.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,o=i,n.next=4,o.prepareMessage(i.version,t,e);case 4:c=n.sent,(l=[o.session.publicKey]).push(o.session.metadata.participants[e].publicKey),c.encryptPrivateMessage(l),c.sign(i.session.privateKey),(u=new M(o.version)).headers.pkfpSource=i.session.publicKeyFingerprint,u.headers.pkfpDest=e,u.headers.command="send_message",u.headers.private=!0,u.body.message=c.toBlob(),d=i.session.privateKey,u.signMessage(d),i.chatSocket.emit("request",u),r(),n.next=24;break;case 21:n.prev=21,n.t0=n.catch(0),a(n.t0);case 24:case"end":return n.stop()}}),n,null,[[0,21]])})));return function(e,t){return n.apply(this,arguments)}}())}},{key:"processIncomingMessage",value:function(e,t){console.log("Received incoming message! ");var n=e.message,i=e.key?C.privateKeyDecrypt(e.key,t.session.privateKey):t.session.metadata.sharedKey,r=new _(n.body.message),s=t.session.metadata.participants[r.header.author];if(!s)throw"Author is not found in the current version of metadata!";if(r.verify(s.publicKey)||t.emit("error","Received message with invalid signature!"),!r.header.private&&!e.key&&r.header.metadataID!==t.session.metadata.id)throw"current metadata cannot decrypt this message";r.header.private?r.decryptPrivateMessage(t.session.privateKey):r.decryptMessage(i);var a=r.header.nickname,o=r.header.author,c=t.getMemberNickname(o);this.nicknameAssigned(o)&&a===t.getMemberNickname(o)||(t.setMemberNickname(o,a),t.saveClientSettings(),t.createServiceRecordOnMemberNicknameChange(c,a,o)),t.emit("chat_message",r)}},{key:"nicknameAssigned",value:function(e){try{return this.session.settings.membersData[e].hasOwnProperty("nickname")}catch(e){return!1}}},{key:"messageSendSuccess",value:(r=o()(s.a.mark((function e(t,n){var i,r;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=new _(t.body.message),r=n.session.metadata.participants[i.header.author]){e.next=4;break}throw"Author is not found in the current version of metadata!";case 4:if(i.verify(r.publicKey)||n.emit("error","Received message with invalid signature!"),i.header.private||i.header.metadataID===n.session.metadata.id){e.next=7;break}throw"current metadata cannot decrypt this message";case 7:i.header.private?i.decryptPrivateMessage(n.session.privateKey):i.decryptMessage(n.session.metadata.sharedKey),n.emit("send_success",i);case 9:case"end":return e.stop()}}),e)}))),function(e,t){return r.apply(this,arguments)})},{key:"messageSendFail",value:function(e,t){var n=JSON.parse(e).body.message.header.id;t.emit("send_fail",t.outgoingMessageQueue[n]),delete t.outgoingMessageQueue[n]}},{key:"isLoggedIn",value:function(){return this.session&&"active"===this.session.status}},{key:"requestInvite",value:function(){(new g).createNonce("n").bytesToHex("n","nhex");var e=new M(self.version),t=C.encryptStandardMessage(this.session.settings.nickname,this.session.metadata.topicAuthority.publicKey),n=C.encryptStandardMessage(this.session.settings.topicName,this.session.metadata.topicAuthority.publicKey);e.headers.command="request_invite",e.headers.pkfpSource=this.session.publicKeyFingerprint,e.headers.pkfpDest=this.session.metadata.topicAuthority.pkfp,e.body.nickname=t,e.body.topicName=n,e.signMessage(this.session.privateKey),this.chatSocket.emit("request",e)}},{key:"syncInvites",value:function(){var e=new g;e.createNonce("n").bytesToHex("n","nhex");var t=new M(self.version);t.headers.command="sync_invites",t.headers.pkfpSource=this.session.publicKeyFingerprint,t.headers.pkfpDest=this.session.metadata.topicAuthority.pkfp,t.headers.nonce=e.get("nhex"),t.signMessage(this.session.privateKey),this.chatSocket.emit("request",t)}},{key:"syncInvitesSuccess",value:function(e,t){if(!M.verifyMessage(t.session.metadata.topicAuthority.publicKey,e))throw"invalid message";t.updatePendingInvites(e.body.invites),t.emit(e.headers.response)}},{key:"generateInvite",value:function(){if(this.session&&"active"===this.session.status){var e=new g;e.createNonce("iid").bytesToHex("iid","iidhex");var t={requestID:e.get("iidhex"),pkfp:this.session.publicKeyFingerprint},n=new M(self.version);n.headers.command="request_invite",n.set("body",t),n.signMessage(this.session.privateKey),this.chatSocket.emit("request",n)}else this.emit("login_required")}},{key:"joinTopicError",value:function(e,t){console.log("Topic join error: "+e.headers.error),t.emit("topic_join_error",e.headers.error)}},{key:"requestInviteError",value:function(e,t){console.log("Request invite error received: "+e.headers.error),t.emit("request_invite_error",e.headers.error)}},{key:"syncInvitesError",value:function(e,t){console.log("Sync invites error received: "+e.headers.error),t.emit("sync_invites_error",e.headers.error)}},{key:"processInviteCreated",value:function(e,t){t.updatePendingInvites(e.body.userInvites),t.emit("request_invite_success",e.body.inviteCode)}},{key:"updateSetInviteeName",value:function(e,t){this.session.settings.invites[e].name=t,this.saveClientSettings(this.session.settings,this.session.privateKey)}},{key:"saveInviteSuccess",value:function(e,t){t.updatePendingInvites(e.body.userInvites),t.emit("invite_generated",t.session.pendingInvites[e.body.inviteID])}},{key:"updateInviteSuccess",value:function(e,t){t.updatePendingInvites(e.body.invites),t.emit("invite_updated")}},{key:"updatePendingInvites",value:function(e){var t=!0,n=!1,i=void 0;try{for(var r,s=e[Symbol.iterator]();!(t=(r=s.next()).done);t=!0){var a=r.value;this.session.settings.invites.hasOwnProperty(a)||(this.session.settings.invites[a]={})}}catch(e){n=!0,i=e}finally{try{t||null==s.return||s.return()}finally{if(n)throw i}}for(var o=0,c=Object.keys(this.session.settings.invites);o<c.length;o++){var l=c[o];e.includes(l)||delete this.session.settings.invites[l]}this.saveClientSettings(this.session.settings,this.session.privateKey)}},{key:"settingsInitInvites",value:function(){this.session.settings.invites={},this.saveClientSettings(this.session.settings,this.session.privateKey)}},{key:"deleteInvite",value:function(e){console.log("About to delete invite: "+e);var t=new M(self.version);t.headers.command="del_invite",t.headers.pkfpSource=this.session.publicKeyFingerprint,t.headers.pkfpDest=this.session.metadata.topicAuthority.pkfp;var n={invite:e};t.set("body",n),t.signMessage(this.session.privateKey),this.chatSocket.emit("request",t)}},{key:"delInviteSuccess",value:function(e,t){console.log("Del invite success! "),t.updatePendingInvites(e.body.invites),t.emit("del_invite_success")}},{key:"getPendingInvites",value:function(){console.log("Del invite fail! "),self.emit("del_invite_fail")}},{key:"inviteRequestValid",value:function(e,t,n){return n&&n&&this.onionValid(e)}},{key:"_establishChatConnection",value:(i=o()(s.a.mark((function e(){var t,n,i=this,r=arguments;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.length>0&&void 0!==r[0]?r[0]:7,n=r.length>1&&void 0!==r[1]?r[1]:8e3,e.abrupt("return",new Promise((function(e,r){var s=i,a=1===i.transport;if(s.chatSocket&&s.chatSocket.connected)e();else{var o=0;s.chatSocket=q("/chat",{reconnection:!1,forceNew:!0,autoConnect:!1,upgrade:a,pingInterval:1e4,pingTimeout:5e3}),s.chatSocket.on("connect",(function(){i.finishSocketSetup(),console.log("Island connection established"),i.islandConnectionStatus=!0,i.emit("connected_to_island"),e()})),s.chatSocket.on("disconnect",(function(){console.log("Island disconnected."),i.islandConnectionStatus=!1,i.emit("disconnected_from_island")})),s.chatSocket.on("connect_error",(function(e){o<t?(console.log("Connection error on attempt: "+o+e),o+=1,setTimeout(c,n)):(console.log("Connection Failed"),r(e))})),s.chatSocket.on("connect_timeout",(function(e){console.log("Chat connection timeout"),r(e)})),c()}function c(){console.log("Attempting island connection: "+o),s.chatSocket.open()}})));case 3:case"end":return e.stop()}}),e)}))),function(){return i.apply(this,arguments)})},{key:"_establishFileConnection",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:7,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8e3;return new Promise((function(i,r){var s=e,a=1===e.transport;if(console.log("Connecting to file socket"),s.fileSocket&&s.fileSocket.connected)return console.log("File socket already connected! returning"),void i();var o=0;function c(){console.log("Attempting island connection: "+o),s.fileSocket.open()}s.fileSocket=q("/file",{reconnection:!1,forceNew:!0,autoConnect:!1,upgrade:a,pingInterval:1e4,pingTimeout:5e3}),s.fileSocket.on("connect",(function(){e.setupFileTransferListeners(),console.log("File transfer connectiopn established"),i()})),s.fileSocket.on("connect_error",(function(e){o<t?(console.log("Connection error on attempt: "+o+e),o+=1,setTimeout(c,n)):(console.log("Connection Failed"),r(e))})),s.fileSocket.on("connect_timeout",(function(e){console.log("File connection timeout"),r(e)})),c()}))}},{key:"establishIslandConnection",value:(n=o()(s.a.mark((function e(){var t,n=arguments;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=n.length>0&&void 0!==n[0]?n[0]:"chat",console.log("Establishing connection with: "+t),"chat"!==t){e.next=6;break}return e.abrupt("return",this._establishChatConnection());case 6:if("file"!==t){e.next=8;break}return e.abrupt("return",this._establishFileConnection());case 8:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"terminateIslandConnection",value:(t=o()(s.a.mark((function e(){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,this.chatSocket&&this.chatSocket.connected&&this.chatSocket.disconnect(),e.next=7;break;case 4:throw e.prev=4,e.t0=e.catch(0),"Error terminating connection with island: "+e.t0;case 7:case"end":return e.stop()}}),e,this,[[0,4]])}))),function(){return t.apply(this,arguments)})},{key:"finishSocketSetup",value:function(){this.initChatListeners()}},{key:"initChatListeners",value:function(){var e=this;this.chatSocket.on("message",(function(e){console.log(JSON.stringify(e))})),this.chatSocket.on("request",(function(t){console.log("Received new incoming request"),e.processRequest(t,e)})),this.chatSocket.on("response",(function(t){e.processResponse(t,e)})),this.chatSocket.on("service",(function(t){e.processServiceMessage(t,e)})),this.chatSocket.on("service_record",(function(t){console.log("Got SERVICE RECORD!"),e.processServiceRecord(t,e)})),this.chatSocket.on("message",(function(t){e.processIncomingMessage(t,e)})),this.chatSocket.on("reconnect",(function(e){console.log("Successfull reconnect client")})),this.chatSocket.on("metadata_update",(function(t){e.processMetadataUpdate(t)}))}},{key:"broadcastMetadataUpdate",value:function(e){var t=this,n=this.session.metadata.toBlob(!0),i={myBlob:n,topicID:this.session.metadata.topicID,publicKeyFingerprint:this.session.publicKeyFingerprint,recipients:{}};Object.keys(this.session.metadata.participants).forEach((function(e){t.session.metadata.participants[e].publicKeyFingerprint;var r=t.session.metadata.participants[e].residence;i.recipients[e]={residence:r,metadata:n}})),this.chatSocket.emit("broadcast_metadata_update",i)}},{key:"processMetadataUpdate",value:function(e,t){"new_member_joined"===e.headers.event?t.processNewMemberJoined(e,t):"member_booted"===e.headers.event?t.noteParticipantBooted(e,t):"u_booted"===e.headers.event?this.uWereBooted(e,t):"meta_sync"===e.headers.event&&t.processMetaSync(e,t)}},{key:"processMetaSync",value:function(e,t){t.session&&(console.log("Processing metadata sync message"),e.body.metadata&&(t._updateMetadata(x.parseMetadata(e.body.metadata)),t.emit("metadata_updated")))}},{key:"processNewMemberJoined",value:function(e,t){if(t.session){var n=e.body.pkfp,i=e.body.nickname;t._updateMetadata(x.parseMetadata(e.body.metadata)),t.addNewMemberToSettings(n),t.setMemberNickname(n,i),t.saveClientSettings(),t.emit("new_member_joined")}}},{key:"_updateMetadata",value:function(e){var t=x.extractSharedKey(this.session.publicKeyFingerprint,this.session.privateKey,e);this.session.metadata=e.body,this.session.metadata.sharedKey=t,this.session.metadataSignature=e.signature}},{key:"myNicknameUpdate",value:function(e){if(e){e=e.trim().toString("utf8");var t=this.session.settings;t.nickname!==e&&(t.nickname=e,this.setMemberNickname(this.session.publicKeyFingerprint,e),this.saveClientSettings(t,this.session.privateKey),this.broadcastNameChange())}}},{key:"topicNameUpdate",value:function(e){if(e){e=e.trim().toString("utf8");var t=this.session.settings;t.topicName!==e&&(t.topicName=e,this.saveClientSettings(t,this.session.privateKey))}}},{key:"signBlob",value:function(e,t){var n=new g;return n.setRSAKey("pk",e,"private").addBlob("b",t).privateKeySign("b","pk","sign"),n.get("sign")}},{key:"verifyBlob",value:function(e,t,n){var i=new g;return i.setRSAKey("pubk",e,"public").addBlob("sign",t).addBlob("b",n).publicKeyVerify("b","sign","pubk","v"),i.get("v")}},{key:"generateOnionService",value:function(){var e=forge.rsa.generateKeyPair(1024),t=forge.pki.getPublicKeyFingerprint(e.publicKey,{encoding:"hex",md:forge.md.sha1.create()}),n=forge.pki.privateKeyToPem(e.privateKey);t.length%2!=0&&(t="0"+t);for(var i=[],r=0;r<t.length/2;r+=2)i.push(parseInt(t.slice(r,r+2),16));return{onion:base32.encode(i).toLowerCase()+".onion",privateKey:n}}},{key:"onionAddressFromPrivateKey",value:function(e){var t=new g;t.setRSAKey("privk",e,"private").publicFromPrivate("privk","pubk");var n=forge.pki.publicKeyFromPem(t.get("pubk")),i=forge.pki.getPublicKeyFingerprint(n,{encoding:"hex",md:forge.md.sha1.create()});i.length%2!=0&&(i="0"+i);for(var r=[],s=0;s<i.length/2;s+=2)r.push(parseInt(i.slice(s,s+2),16));return base32.encode(r).toLowerCase()+".onion"}},{key:"extractFromInvite",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"all",n=new g;n.addBlob("is64",e).base64Decode("is64","is");var i=n.get("is").split("/"),r={hsid:i[0],pkfp:i[1],inviteCode:i[2],all:i};try{return r[t]}catch(e){throw"Invalid parameter thingToExtract"}}},{key:"onionValid",value:function(e){return/^[a-z2-7]{16}\.onion$/.test(e)}},{key:"getMyResidence",value:function(){return this.session.metadata.participants[this.session.publicKeyFingerprint].residence}}]),e}(),I=function(){function e(){l()(this,e),console.log("Downloader initialized non-worker"),N.mixin(this)}return d()(e,[{key:"processMessage",value:function(e){console.log("Processing message from main thread.."),commandHandlers[e.command](e.data)}},{key:"parseFileLink",value:function(e){var t=new g;t.addBlob("l",e).base64Decode("l","ls");var n=t.get("ls").split("/");return{onion:n[0],pkfp:n[1],name:n[2]}}},{key:"postMessage",value:function(e){this.emit("message",{data:e})}},{key:"appendBuffer",value:function(e,t){var n=new Uint8Array(e.byteLength+t.byteLength);return n.set(new Uint8Array(e),0),n.set(new Uint8Array(t),e.byteLength),n.buffer}},{key:"downloadFile",value:function(e){var t=this;this.processDownload(e).then((function(e){t.postMessage({message:"download_complete",data:e}),console.log("Stream finished")})).catch((function(e){console.log("Error downloading file: "+e),t.postMessage({message:"download_failed",data:e})}))}},{key:"processDownload",value:function(e){var t=this,n=this;return new Promise(function(){var i=o()(s.a.mark((function i(r,a){var o,c,l,u,d,p,h;return s.a.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return console.log("Initializing file download"),o=JSON.parse(e.fileInfo),c=n.parseFileLink(o.link),l=e.myPkfp,u=e.privk,d=e.pubk,p=o.metaID,i.prev=7,i.next=10,t.establishConnection();case 10:h=i.sent,i.next=16;break;case 13:i.prev=13,i.t0=i.catch(7),a("Connection error: "+i.t0);case 16:h.on("download_ready",(function(e){n.postMessage({message:"file_available_locally"});var t=e[p],i=new ArrayBuffer(0);ss(h).on("file",(function(e){console.log("File download in progress!");var s=new g;s.addBlob("k",t).asym.setKey("privk",u,"private").asym.decrypt("k","privk","symk","hex"),s.createHash("h"),s.ssym.init("stc",s.get("symk"),!1),e.on("data",(function(e){n.postMessage({message:"log",data:"Received data chunk"});var t=s.ssym.decrypt("stc",e.buffer);s.updateHash("h",new Uint8Array(t)),i=g.concatArrayBuffers(i,t)})),e.on("end",(function(){n.postMessage({message:"log",data:"Received end of data message"}),s.digestHash("h","hres").addBlob("sign",o.signUnencrypted).asym.setKey("pubk",d,"public").asym.verify("hres","sign","pubk","vres"),s.get("vres")?(n.postMessage({message:"log",data:"Resolving data..."}),r(i)):a("File validation error!")}))})),console.log("About to emit process_download"),h.emit("proceed_download",{link:c,pkfp:l})})),h.on("requesting_peer",(function(){console.log("File not found locally, requesting hidden peer"),n.postMessage({message:"requesting_peer"})})),h.on("download_failed",(function(e){console.log("File download fail: "+e),n.postMessage({message:"download_failed",data:e})})),h.emit("download_attachment",{link:c,myPkfp:l,metaID:o.metaID,hashEncrypted:o.hashEncrypted,signEncrypted:o.signEncrypted});case 20:case"end":return i.stop()}}),i,null,[[7,13]])})));return function(e,t){return i.apply(this,arguments)}}())}},{key:"establishConnection",value:function(){var e=this;return new Promise((function(t,n){console.log("Connecting to file socket...");var i=0;e.postMessage({message:"log",data:"Connecting to file socket..."});var r=q("/file",{autoConnect:!1,reconnection:!1,upgrade:!1,pingInterval:1e4,pingTimeout:5e3}),s=function(){e.postMessage({message:"log",data:"Attempting connection: "+i}),r.open()},a=function(t){if(i<5){var r="Connection error on attempt ".concat(i,": ").concat(t);e.postMessage({message:"log",data:r}),i++,setTimeout(s,5e3)}else{var a="Connection error on attempt ".concat(i,": ").concat(t,"\nRejecting!");e.postMessage({message:"log",data:a}),n(t)}};r.on("connect",(function(){e.postMessage({message:"log",data:"File transfer connection established"}),t(r)})),r.on("connect_error",(function(e){a(e)})),r.on("connect_timeout",(function(){a("Connection timeout.")})),s()}))}}]),e}();window.toastr=E;var L,B=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],D=["#cfeeff","#ffebcc","#ccffd4","#ccfffb","#e6e6ff","#f8e6ff","#ffe6f1","#ccefff","#ccf1ff"],O=[],F=!1,H={},U=!1,j={on:"/img/sound-on.png",off:"/img/sound-off.png"},J=!1;function V(e){T.session.settings.soundsOn&&H[e].play()}function W(e,t){"end"===t?function(e){if("number"==typeof e.selectionStart)e.selectionStart=e.selectionEnd=e.value.length;else if(void 0!==e.createTextRange){e.focus();var t=e.createTextRange();t.collapse(!1),t.select()}}(e):"start"===t&&function(e){if("number"==typeof e.selectionStart)e.selectionStart=e.selectionEnd=0;else if(void 0!==e.createTextRange){e.focus();var t=e.createTextRange();t.collapse(!1),t.select()}}(e)}function Y(){return z.apply(this,arguments)}function z(){return(z=o()(s.a.mark((function e(){var t;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return he(),console.log("called topic login"),t=document.querySelector("#private-key").value,Ke(),e.next=6,T.topicLogin(t);case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function G(){if(De(),!J){Oe(!0);var e=document.querySelector("#new-msg"),t=document.querySelector("#attach-file").files,n=document.querySelector("#select-member"),i=n[n.selectedIndex].value;""!==e.value.trim()||0!==t.length?("ALL"===i?T.shoutMessage(e.value.trim().substring(0,65536),t).then((function(){console.log("Send message resolved")})).catch((function(e){console.log("Error sending message"+e.message),Oe(!1)})):T.whisperMessage(i,e.value.trim().substring(0,65536)).then((function(){console.log("Done whispering message!")})).catch((function(e){console.log("Error sending message"+e.message),Oe(!1)})),e.value=""):Oe(!1)}}function Q(e){var t=new Date(e),n=new Date;return Math.floor((n-t)/1e3)<=64e3?t.getHours()+":"+X(2,t.getMinutes()):B[t.getDay()]+", "+t.getMonth()+"/"+X(2,t.getDate())+" "+X(2,t.getHours())+":"+X(2,t.getMinutes())}function X(e,t){var n="0".repeat(e)+String(t).trim();return n.substr(n.length-e)}function Z(e){return T.session.publicKeyFingerprint===e}function ee(e){console.log("About to boot participant"),De();var t=e.target.parentElement.parentElement.lastElementChild.innerHTML;T.session.settings.membersData[t];if(t==T.session.publicKeyFingerprint&&confirm("Are you sure you want to leave this topic?"))console.log("Leaving topic");else{var n=T.getMemberRepr(t);confirm("Are you sure you want to boot "+n+"? ")&&T.bootParticipant(t)}}function te(e){var t=T.session.metadata.participants[T.session.publicKeyFingerprint].rights,n=document.querySelector("#participants-records"),i=T.session.metadata.participants[e];if(i){var r=document.createElement("div"),s=document.createElement("div"),a=document.createElement("div"),o=document.createElement("div"),c=document.createElement("div"),l=document.createElement("div");s.setAttribute("class","participant-id"),r.setAttribute("class","participant-wrapper"),a.setAttribute("class","p-nickname"),o.setAttribute("class","p-rights"),c.setAttribute("class","p-actions"),l.setAttribute("class","boot-participant"),l.addEventListener("click",ee),a.innerHTML=T.getMemberRepr(e),o.innerHTML=i.rights,l.innerHTML="Boot",s.innerHTML=e,r.appendChild(s),r.appendChild(a),r.appendChild(o),3===t&&c.appendChild(l),r.appendChild(c),r.appendChild(s),n.appendChild(r)}else console.error("Error adding participant")}function ne(){$("#online-users-list").html(""),$("#participants-records").html(""),$("#participants--topic-name").html("Topic: "+T.session.settings.topicName);var e=T.session.publicKeyFingerprint;O=Object.keys(T.session.metadata.participants).filter((function(t){return t!==e}));var t=document.querySelector("#select-member"),n=t.value,i=document.createElement("option");i.setAttribute("value","ALL"),i.innerText="All",t.innerHTML="",t.appendChild(i);var r=!0,s=!1,a=void 0;try{for(var o,c=O[Symbol.iterator]();!(r=(o=c.next()).done);r=!0){var l=o.value;te(l);var u=document.createElement("span");u.classList.add("online-user-id"),u.innerText=l;var d=document.createElement("img");d.classList.add("participant-status"),d.setAttribute("src","/img/online.png");var p=document.createElement("input");p.value=T.getMemberAlias(l)||T.getMemberNickname(l)||"Anonymous",p.addEventListener("change",Be),p.classList.add("participant-alias");var h=document.createElement("div");if(h.classList.add("online-user-row"),h.appendChild(u),h.appendChild(d),h.appendChild(p),T.getMemberAlias(l)){var y=document.createElement("span");y.innerText="("+(T.getMemberNickname(l)||"Anonymous")+")",h.appendChild(y)}document.querySelector("#online-users-list").appendChild(h);var v=document.createElement("option");v.setAttribute("value",l),v.innerText=p.value+" ("+T.getMemberNickname(l)+")",t.appendChild(v)}}catch(e){s=!0,a=e}finally{try{r||null==c.return||c.return()}finally{if(s)throw a}}if("ALL"!==n){var g=!0,f=!1,m=void 0;try{for(var b,k=O[Symbol.iterator]();!(g=(b=k.next()).done);g=!0){if(b.value===n){t.value=n;break}}}catch(e){f=!0,m=e}finally{try{g||null==k.return||k.return()}finally{if(f)throw m}}}var w=document.querySelector("#participants-records");w.children.length>0&&w.lastChild.classList.add("participant-wrapper-last")}function ie(){document.querySelector("#chat_window").childNodes.forEach((function(e){if(!e.classList.contains("service-record"))if(e.classList.contains("my_message")){if(!e.classList.contains("private-message"))return;try{var t=e.firstChild,n=t.querySelector(".m-recipient-id").innerHTML;t.querySelector(".private-mark").innerText="(private to "+T.getMemberAlias(n)+")"}catch(e){console.error(e)}}else try{var i=e.firstChild,r=i.querySelector(".m-author-id").innerHTML;i.querySelector(".m-alias").innerText=T.getMemberAlias(r)}catch(e){console.error(e)}}))}function re(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=document.querySelector("#chat_window"),i=document.createElement("div"),r=document.createElement("div"),s=document.createElement("div");s.classList.add("msg-body");var a=function(e){var t,n,i=document.createElement("div");i.classList.add("msg-heading"),e.alias&&((t=document.createElement("b")).classList.add("m-alias"),t.innerText=e.alias,(n=document.createElement("span")).innerText="  --  ");var r=document.createElement("b");r.innerText=e.nickname,r.classList.add("m-nickname");var s=document.createElement("span");s.innerHTML=Q(e.timestamp),s.classList.add("msg-time-stamp"),Z(e.pkfp)?(i.appendChild(s),i.appendChild(r)):e.service?(i.innerHTML+="<b>Service  </b>",i.appendChild(s)):(e.alias&&(i.appendChild(t),i.appendChild(n)),i.appendChild(r),i.appendChild(s));if(e.recipient&&"ALL"!==e.recipient){var a=document.createElement("div");a.innerHTML=e.recipient,a.classList.add("m-recipient-id"),i.appendChild(a)}return i}(e);if(Z(e.pkfp))i.classList.add("my_message");else if(e.service)i.classList.add("service-record");else{i.classList.add("message");var o=document.createElement("div");o.classList.add("m-author-id"),o.innerHTML=e.pkfp,i.style.backgroundColor=D[O.indexOf(e.pkfp)%D.length],a.appendChild(o)}if(e.private){var c=function(e){var t=document.createElement("span");if(t.classList.add("private-mark"),Z(e.pkfp)){t.innerText="(private to: ";var n=T.getMemberRepr(e.recipient);t.innerText+=n+")"}else t.innerText="(private)";return t}(e);a.appendChild(c),i.classList.add("private-message")}r.classList.add("message-id"),r.innerHTML=e.messageID,a.appendChild(r),s.appendChild(function(e){e=e.trim();var t=document.createElement("div"),n=/__code/,i=/__end/;if(-1===e.search(n))return t.appendChild(document.createTextNode(e)),t;var r=e.search(n);e.substring(0,r).length>0&&(t.appendChild(document.createTextNode(e.substring(0,r))),e=e.substr(r));for(var s=e.split(n).filter((function(e){return 0!==e.length})),a=0;a<s.length;++a){var o=document.createElement("pre"),c=document.createElement("code"),l=null,u=s[a].search(i);if(-1===u)c.innerText=ue(s[a]);else{c.innerText=ue(s[a].substring(0,u));var d=s[a].substr(u+5).trim();d.length>0&&(l=document.createTextNode(d))}hljs.highlightBlock(c),o.appendChild(c),t.appendChild(o),o.ondblclick=oe,l&&t.appendChild(l)}return t}(e.body));var l=function(e){if(void 0===e)return;var t=document.createElement("div");t.classList.add("msg-attachments");var n=!0,i=!1,r=void 0;try{for(var s,a=e[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var o=s.value,c=document.createElement("div"),l=document.createElement("div"),u=document.createElement("div"),d=document.createElement("span"),p=document.createElement("span"),h=document.createElement("span"),y=document.createElement("img"),v=document.createElement("div");v.classList.add("att-state");var g=document.createElement("img");g.classList.add("spinner"),g.src="/img/spinner.gif",g.display="flex",v.appendChild(g),y.src="/img/attachment.png",d.classList.add("att-size"),l.classList.add("att-view"),u.classList.add("att-info"),p.classList.add("att-name"),y.classList.add("att-icon"),h.appendChild(y),u.innerHTML=JSON.stringify(o),p.innerText=o.name,d.innerHTML=(f=o.size,(f=parseInt(f))<1e3?f.toString()+"b":f<1e6?Number((f/1e3).toFixed(1)).toString()+"kb":f<1e9?Number((f/1e6).toFixed(1)).toString()+"mb":Number((f/1e9).toFixed(1)).toString()+"gb"),l.appendChild(v),l.appendChild(h),l.appendChild(p),l.appendChild(d),l.addEventListener("click",se),c.appendChild(l),c.appendChild(u),t.appendChild(c)}}catch(e){i=!0,r=e}finally{try{n||null==a.return||a.return()}finally{if(i)throw r}}var f;return t}(e.attachments);i.appendChild(a),i.appendChild(s),void 0!==l&&i.appendChild(l),t?n.insertBefore(i,n.firstChild):(n.appendChild(i),n.scrollTop=n.scrollHeight)}function se(e){return ae.apply(this,arguments)}function ae(){return(ae=o()(s.a.mark((function e(t){var n,i,r;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(console.log("Download event triggered!"),n=t.target;n&&!n.classList.contains("att-view");)n=n.parentNode;if(n){e.next=5;break}throw"att-view container not found...";case 5:return i=n.nextSibling.innerHTML,r=JSON.parse(i).name,n.childNodes[0].style.display="inline-block",e.prev=8,e.next=11,T.downloadAttachment(i);case 11:console.log("Download complete!"),e.next=18;break;case 14:e.prev=14,e.t0=e.catch(8),E.warning("file download unsuccessfull: "+e.t0),Fe(r+" Download finished with error: "+e.t0);case 18:return e.prev=18,n.childNodes[0].style.display="none",e.finish(18);case 21:case"end":return e.stop()}}),e,null,[[8,14,18,21]])})))).apply(this,arguments)}function oe(e){var t=document.createElement("pre");t.innerHTML=e.target.innerHTML;var n=document.createElement("div");n.appendChild(t),pe("Code:",n.innerHTML)}function ce(){le(),document.querySelector("#code-view").style.display="none"}function le(){document.querySelector("#code--content").innerHTML=""}function ue(e){for(var t=(e=e.trim()).match(/\r?\n/)?e.match(/\r?\n/)[0]:"\r\n",n=e.split(/\r?\n/),i=1/0,r=1;r<n.length;++r)if(""!==n[r])try{i=Math.min(n[r].match(/^\s+/)[0].length,i)}catch(e){return n.join(t)}for(var s=1;s<n.length;++s)n[s]=n[s].substr(i);return n.join(t)}function de(e){De(),console.log("Generating invite"),qe(e.target),T.requestInvite()}function pe(e,t){var n=document.createElement("div");n.classList.add("modal-notification--wrapper");var i=document.createElement("h3");i.classList.add("modal-notification--heading");var r=document.createElement("div");r.classList.add("modal-notification--body"),i.innerText=e,r.innerHTML=t,n.appendChild(i),n.appendChild(r);var s=document.querySelector("#code--content");s.innerHTML="",s.appendChild(n),document.querySelector("#code-view").style.display="block"}function he(){$("body").waitMe({effect:"roundBounce",bg:"rgba(255,255,255,0.7)",textPos:"vertical",color:"#33b400"})}function ye(){$("body").waitMe("hide")}function ve(e){switch(e){case"chat":$("#chat_room").css("display","flex"),$("#you_online").css("display","flex"),$("#auth-wrapper").hide(),$("#chat-menu").css("display","flex"),$("#settings-view").hide(),$("#chat-view-button").addClass("active"),$("#settings-view-button ").removeClass("active");break;case"auth":$("#chat_room").hide(),$("#you_online").hide(),$("#auth-wrapper").css("display","block"),$("#chat-menu").hide(),$("#settings-view").hide();break;case"settings":$("#settings-view").css("display","flex"),$("#chat_room").hide(),$("#you_online").hide(),$("#auth-wrapper").hide(),$("#chat-menu").css("display","flex"),$("#chat-view-button").removeClass("active"),$("#settings-view-button").addClass("active");break;default:throw"setView: Invalid view: "+e}}function ge(){if(T.session)if(void 0!==T.session.settings.invites){var e=Object.keys(T.session.settings.invites),t=document.querySelector("#pending-invites");for(var n in t.innerHTML="",e){var i=document.createElement("div"),r=document.createElement("div"),s=document.createElement("input"),a=document.createElement("div"),o=document.createElement("div"),c=document.createElement("div"),l=document.createElement("button"),u=document.createElement("button");i.classList.add("invite-wrap"),s.classList.add("invite-rep"),c.classList.add("invite-id"),o.classList.add("invite-del"),r.classList.add("invite-num"),u.classList.add("invite-del-button"),l.classList.add("invite-copy-button"),a.classList.add("invite-copy"),u.innerText="Del",l.innerText="Copy invite code",u.onclick=we,c.innerText=e[n],s.value=T.session.settings.invites[e[n]].name?T.session.settings.invites[e[n]].name:"New member",r.innerText="#"+(parseInt(n)+1),o.appendChild(u),a.appendChild(l),i.appendChild(r),i.appendChild(s),i.appendChild(a),i.appendChild(o),i.appendChild(c),l.addEventListener("click",ke),s.addEventListener("click",fe),t.appendChild(i)}}else T.settingsInitInvites()}function fe(e){L=e.target.value,e.target.value="",e.target.addEventListener("focusout",be),e.target.addEventListener("keyup",me)}function me(e){13===e.keyCode&&(console.log("Enter pressed!"),e.target.blur())}function be(e){var t=e.target.value.trim();""!==t?(T.updateSetInviteeName(e.target.parentNode.lastChild.innerHTML,t),e.target.removeEventListener("focusout",be)):e.target.value=L}function ke(e){var t=e.target.parentNode.parentNode.lastChild.innerHTML,n=document.createElement("textarea");n.value=t,document.body.appendChild(n),n.focus(),n.select();try{document.execCommand("copy"),E.info("Invite code was copied to the clipboard")}catch(e){E.error("Error copying invite code to the clipboard")}n.remove()}function we(e){De();var t=e.target.parentNode.parentNode.lastChild.innerHTML;T.deleteInvite(t)}function Se(e){var t=document.querySelector("#settings-menu").children,n=!0,i=!1,r=void 0;try{for(var s,a=t[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){s.value.classList.remove("active")}}catch(e){i=!0,r=e}finally{try{n||null==a.return||a.return()}finally{if(i)throw r}}var o=e.target;o.classList.add("active"),document.querySelector("#invites-container").style.display="INVITES"===o.innerText?"flex":"none",document.querySelector("#participants-container").style.display="PARTICIPANTS"===o.innerText?"flex":"none",document.querySelector("#chat-settings").style.display="CHAT SETTINGS"===o.innerText?"flex":"none"}function Ee(e){var t=e.target;if(t.firstChild&&e.target.scrollTop<=1){console.log("loading more messages");var n=t.firstChild.querySelector(".message-id").innerText;T.loadMoreMessages(n)}}function Ke(){$("#private-key").val("")}function _e(e){var t=document.querySelector("#chat_window"),n=!0,i=!1,r=void 0;try{for(var s,a=t.children[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var o=s.value;if(o.getElementsByClassName("message-id")[0].innerHTML==e)return console.log("Message found"),o}}catch(e){i=!0,r=e}finally{try{n||null==a.return||a.return()}finally{if(i)throw r}}}function Ce(){return(Ce=o()(s.a.mark((function e(t,n){var i,r,a,o,c;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=_e(t.messageID)){e.next=4;break}return console.error("Message not found"),e.abrupt("return");case 4:r=document.createElement("audio"),a=new Uint8Array(n),o=URL.createObjectURL(new Blob([a])),r.setAttribute("controls",""),r.setAttribute("src",o),(c=i.getElementsByClassName("att-view")[0]).innerHTML="",c.appendChild(r),console.log("Removing even listener"),c.removeEventListener("click",se);case 14:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Me(e){var t=document.querySelector("#chosen-files"),n=e.target.files[0];if(t.innerHTML="",n){var i=document.createElement("div");i.classList.add("chosen-file-wrap");var r=document.createElement("div");r.classList.add("chosen-file"),r.innerText=n.name;var s=document.createElement("img");s.setAttribute("src","/img/close.png"),s.addEventListener("click",xe),i.appendChild(s),i.appendChild(r),t.appendChild(i)}}function xe(){document.querySelector("#attach-file").value="",document.querySelector("#chosen-files").innerHTML=""}function Ae(e){var t=e.target.value.trim().toString("utf8");if(!t||t===T.session.settings.nickname)return e.target.value=T.session.settings.nickname,void e.target.blur();e.target.value=t,T.myNicknameUpdate(e.target.value),e.target.blur()}function Re(e){var t=e.target.value.trim();if(!t||t===T.session.settings.topicName)return e.target.value=T.session.settings.topicName,void e.target.blur();e.target.value=t,T.topicNameUpdate(e.target.value),e.target.blur(),document.title=T.session.settings.topicName+" | Islands"}function qe(e){e.classList.add("running"),e.classList.add("disabled")}function Ne(e){e.classList.remove("running"),e.classList.remove("disabled")}function Te(e){De(),console.log("Generating invite"),qe(e.target),T.syncInvites()}function Pe(e){if(!(Number.isInteger(e)&&0<=e<=2))throw"Switch connection status: status is invalid";switch(e){case 0:S("#connection-status--connected"),w("#connection-status--disconnected"),w("#connection-status--connecting"),Fe("Connection with island established");break;case 1:w("#connection-status--connected"),S("#connection-status--disconnected"),w("#connection-status--connecting"),Fe("Connection with island lost");break;case 2:S("#connection-status--connecting"),w("#connection-status--connected"),w("#connection-status--disconnected"),Fe("Connecting to island...")}}function Ie(){F?console.log("Already connecting..."):T.islandConnectionStatus?console.log("Already connected"):(console.log("Attempting reconnection..."),F=!0,Pe(2),T.attemptReconnection().then((function(){console.log("Reconnection attempt resolved")})).catch((function(e){console.trace("Reconnection error: "+e),F=!1,Pe(1)})).finally((function(){console.log("Finally block after reconnection attempt"),Pe(T.islandConnectionStatus?0:1)})))}function Le(e){T.session.settings.soundsOn?(T.session.settings.soundsOn=!1,e.target.src=j.off):(T.session.settings.soundsOn=!0,e.target.src=j.on)}function Be(e){console.log("Processing participant alias change"),De();var t=e.target.parentNode.firstChild.innerText;e.target.value.trim()?T.setMemberAlias(t,e.target.value):T.deleteMemberAlias(t),T.saveClientSettings()}function De(){if(!T.islandConnectionStatus)throw E.warning("You are disconnected from the island. Please reconnect to continue"),"No island connection"}function Oe(e){J=!!e;var t=document.querySelector("#send-new-msg"),n=document.querySelector("#new-msg");J?qe(t):Ne(t),J?n.setAttribute("disabled",!0):n.removeAttribute("disabled")}function Fe(e){if(e)try{var t=m("div",{classes:"ephemeral-msg"}),n=m("div",{classes:"msg-heading"}),i=m("b",{text:"Ephemeral"}),r=m("span",{classes:"msg-time-stamp"});r.innerText=Q(new Date),b(n,[i,r]);var s=m("div",{classes:"msg-body"}),a=m("div",{html:e});s.appendChild(a),b(t,[n,s]),k("#chat_window").appendChild(t)}catch(e){console.log("EPHEMERAL ERROR: "+e)}else console.log("Message is empty.")}document.addEventListener("DOMContentLoaded",(function(e){var t;document.title="Islands",console.log("initializing chat...."),T=new P({version:version}),function(){for(var e={incoming_message:"message_incoming.mp3",message_sent:"message_sent.mp3",user_online:"user_online.mp3"},t=0,n=Object.keys(e);t<n.length;t++){var i=n[t];H[i]=new Audio("/sounds/"+e[i]),H[i].load()}}(),ve("auth"),(t=T).on("init_topic_success",(function(e){ye(),displayNewTopicData(e)})),t.on("init_topic_error",(function(e){var t;t=e instanceof Error?e.message:e,ye(),E.error("Topic was not created. Error: "+t)})),t.on("login_success",(function(e){document.querySelector("#sounds-switch").src=t.session.settings.soundsOn?j.on:j.off,ye(),le(),$("#invite-code").val(""),$("#join-nickname").val(""),$("#new-topic-nickname").val(""),$("#new-topic-name").val(""),Ke(),function(e){ve("chat");var t=k("#user-name"),n=k("#topic-name");k("#user-id").innerText="Your id: "+T.session.publicKeyFingerprint,t.value=T.session.settings.nickname,n.value=T.session.settings.topicName,f(t,13),f(n,13),console.log("USER PKFP: "+T.session.publicKeyFingerprint),T.session.metadata.topicName&&(document.title=T.session.metadata.topicName),ne(),$("#chat-view-button").click((function(){ve("chat")})),$("#settings-view-button").click((function(){ve("settings")})),$("#logout-button").click((function(){console.log("Processing logout"),document.querySelector("#chat_window").innerHTML="",T.logout(),document.location="/",E.info("You have successfully logged out!")})),ge(),function(e){document.querySelector("#chat_window").innerHTML="";for(var t=0;t<e.length;++t){var n=void 0;try{n="string"==typeof e[e.length-t-1]?JSON.parse(e[e.length-t-1]):e[e.length-t-1]}catch(n){console.log("Could not parse json. Message: "+e[e.length-t-1]);continue}var i=n.header.author,r=Z(i)?T.getMemberNickname(i):T.getMemberRepr(i);re({nickname:n.header.nickname,alias:r,body:n.body,timestamp:n.header.timestamp,pkfp:n.header.author,messageID:n.header.id,service:n.header.service,private:n.header.private,recipient:n.header.recipient,attachments:n.attachments})}}(e)}(e),V("user_online"),E.success("You are now online!"),document.title=t.session.settings.topicName+" | Islands"})),t.on("unknown_error",(function(e){console.log("unknown_error emited by chat: "+e),E.error("Chat error: "+e),ye(),Oe(!1),k("#new-msg").focus()})),t.on("login_fail",(function(e){Ke(),ye(),F=!1,console.log("Login fail emited by chat: "+e),E.error("Login fail: "+e)})),t.on("request_invite_success",(function(e){var t;Ne(document.querySelector("#new-invite")),t=e,ge(),pe("Here is your invite code:",t),E.success("New invite was generated successfully!")})),t.on("invite_updated",(function(){E.info("Invite updated!")})),t.on("new_member_joined",(function(e){T.session?(console.log("NEW MEMBER JOINED. UPDATING INFO"),ne(),ge(),E.info("New member just joined the channel!")):console.log("Not logged in, nothing to update")})),t.on("settings_updated",(function(){ne(),ge(),ie()})),t.on("participant_booted",(function(e){ne(),E.info(e)})),t.on("metadata_updated",(function(){ne(),ie()})),t.on("boot_participant_success",(function(e){ne(),E.info(e)})),t.on("u_booted",(function(e){E.warning(e)})),t.on("boot_participant_fail",(function(e){E.warning("Participant booting failed: "+e)})),t.on("del_invite_fail",(function(){E.warning("Error deleting invite")})),t.on("del_invite_success",(function(){ge(),E.info("Invite was deleted")})),t.on("chat_message",(function(e){!function(e){var t=e.header.author,n=T.getMemberNickname(t);n!==e.header.nickname&&(T.setMemberNickname(t,e.header.nickname),n=T.getMemberNickname(t),T.saveClientSettings(T.session.publicKeyFingerprint));var i=T.getMemberAlias(t),r=e.header.timestamp;re({nickname:n,alias:i,timestamp:r,pkfp:t,body:e.body,messageID:e.header.id,private:e.header.private,recipient:e.header.recipient,attachments:e.attachments}),document.hidden&&(document.title="* "+T.session.settings.topicName+" | Islands"),E.info("New message from "+T.getMemberRepr(t))}(e),V("incoming_message")})),t.on("send_success",(function(e){V("message_sent"),function(e){var t=e.header.author,n=T.getMemberNickname(t)||e.header.nickname,i=e.header.timestamp;re({nickname:n,timestamp:i,pkfp:t,body:e.body,messageID:e.header.id,attachments:e.attachments,private:e.header.private,recipient:e.header.recipient}),xe(),function(){var e=k("#chat_window");if(e.childElementCount>=70)for(var t=0;t<20;t++)e.removeChild(e.firstElementChild)}(),Oe(!1),k("#new-msg").focus()}(e)})),t.on("send_fail",(function(e){console.log("Message send fail"),Oe(!1)})),t.on("service_record",(function(e){!function(e){var t=e.header.timestamp;e.header.author,re({nickname:"Service",timestamp:t,messageID:e.header.id,pkfp:"service",body:e.body,service:e.header.service,attachments:e.attachments})}(e)})),t.on("sync_invites_success",(function(){Ne(document.querySelector("#refresh-invites")),E.success("Invites re-synced")})),t.on("sync_invites_error",(function(e){Ne(document.querySelector("#refresh-invites")),E.warning("Invite request failed: "+e)})),t.on("request_invite_error",(function(e){Ne(document.querySelector("#new-invite")),E.warning("Invite request failed: "+e)})),t.on("messages_loaded",(function(e){!function(e){for(;e.length>0;){var t=e.shift();try{t="string"==typeof t?JSON.parse(t):t}catch(t){console.log("Could not parse json. Message: "+e[e.length-i-1]);continue}var n=t.header.author,r=Z(n)?T.getMemberNickname(n):T.getMemberRepr(n);re({nickname:t.header.nickname,alias:r,body:t.body,timestamp:t.header.timestamp,pkfp:t.header.author,service:t.header.service,private:t.header.private,recipient:t.header.recipient,messageID:t.header.id,attachments:t.attachments},!0)}}(e)})),t.on("connected_to_island",(function(){F=!1,Oe(),Pe(0)})),t.on("disconnected_from_island",(function(){Pe(1),Oe(),setTimeout(Ie,1e3)})),t.on("download_complete",(function(e){var t=JSON.parse(e.fileInfo),n=e.fileData;/audio/.test(t.type)?function(e,t){Ce.apply(this,arguments)}(t,n):function(e,t){Fe(e+" Download successfull.");var n,i,r,s=new Uint8Array(t);n=URL.createObjectURL(new Blob([s])),i=e,(r=document.createElement("a")).download=i,r.href=n,document.body.appendChild(r),r.click(),document.body.removeChild(r)}(t.name,n)})),t.on("file_available_locally",(function(e){Fe(e+" file available locally. Downloading...")})),t.on("requesting_peer",(function(e){Fe(e+" file not found locally. Requesting peer...")})),document.querySelector("#send-new-msg").addEventListener("click",G),document.querySelector("#close-code-view").addEventListener("click",ce),document.querySelector("#new-invite").addEventListener("click",de),document.querySelector("#refresh-invites").addEventListener("click",Te),document.querySelector("#attach-file").addEventListener("change",Me),document.querySelector("#re-connect").addEventListener("click",Ie),document.querySelector("#sounds-switch").addEventListener("click",Le),document.querySelector("#re-connect").addEventListener("click",Ie),function(){var e=k("#chat-resizer"),t=k("#chat_room"),n=t.children[0];t.children[2];document.addEventListener("mousedown",(function(t){t.target===e&&(U=!0)})),document.addEventListener("mousemove",(function(e){if(!U)return!1;var i=t.offsetLeft,r=e.clientX-i;n.style.width=Math.max(300,r-8)+"px",n.style.flexGrow=0})),document.addEventListener("mouseup",(function(e){U=!1}))}();var n=k("#user-name"),r=k("#topic-name");n.addEventListener("change",Ae),r.addEventListener("change",Re),$("#new-msg").keyup((function(t){if(!t.ctrlKey&&13===t.keyCode)return e.preventDefault(),G(),W(t.target,"start"),!1;t.ctrlKey&&13===t.keyCode&&(t.target.value+="\n",W(t.target,"end"))})),$("#chat_window").scroll(Ee),$("#private-key").keyup(function(){var e=o()(s.a.mark((function e(t){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(13!==t.keyCode){e.next=3;break}return e.next=3,Y();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),function(){var e=document.querySelector("#settings-menu").children,t=!0,n=!1,i=void 0;try{for(var r,s=e[Symbol.iterator]();!(t=(r=s.next()).done);t=!0){r.value.addEventListener("click",Se)}}catch(e){n=!0,i=e}finally{try{t||null==s.return||s.return()}finally{if(n)throw i}}document.querySelector("#invites-container").style.display="flex",document.querySelector("#chat-settings").style.display="none",document.querySelector("#participants-container").style.display="none"}(),function(){console.log("In autologin");var e=new URL(window.location.href);console.log("URL is "+e),console.log("search params func: "+e.searchParams.get);var t=e.searchParams.get("id");if(console.log("After searching id"),!t)return;var n=e.searchParams.get("token");console.log("Got token: "+n);var i=localStorage.getItem(t);if(!i)return console.log("Autologin failed: no private ley found in local storage"),document.location.href=document.location.origin,void E.warning("Login required.");var r=new g;r.addBlob("pkcip",i).addBlob("key",n).AESDecrypt("pkcip","key","privk",!0,"CBC","utf8");var s=r.get("privk");T.topicLogin(s).then((function(){})).catch((function(){})),localStorage.removeItem(t)}()})),window.onfocus=function(){void 0!==T&&T.isLoggedIn()&&(document.title=T.session.settings.topicName+" | Islands")}}});